var allView={Homepage:"homepage_container",Mainpage:"main_container",DeviceList:"device_list_container",Webview:"webview_container",Setting:"setting_container",Media:"media_container",Split:"split_container",Preference:"prefer_container"},REMOTE_CONTROL_KEY_UP=10,REMOTE_CONTROL_KEY_DOWN=11,REMOTE_CONTROL_KEY_LEFT=12,REMOTE_CONTROL_KEY_RIGHT=13,REMOTE_CONTROL_KEY_ENTER=14,REMOTE_CONTROL_KEY_ESC=15,REMOTE_CONTROL_KEY_BACKSPACE=-1,ESHARE_SWITCH_TO=100,ESHARE_ON=101,ESHARE_OFF=102,DLNA_SWITCH_TO=103,DLNA_ON=104,DLNA_OFF=105,MIRACAST_SWITCH_TO=106,MIRACAST_ON=107,MIRACAST_OFF=108,EPLAY_SWITCH_TO=109,EPLAY_ON=110,EPLAY_OFF=111,QUERY_STATUS=112,MAIN_SWITCH_TO=113,SETTING_SWITCH_TO=114,ES_SPLIT_COUNT=0,ES_SPLIT_POSITION=0,currentAF="web",currentDevice=null,isLoading=!1,EMediaToken=null,GuestPageTitle="",ESClientAppUniqueID=null,ESClientProductID="com.eshare.client",ESClientProProductID="com.eshare.clientpro",CountryCode="US",ES_HOST_MAC="000000000000",ES_SERVER_PORT=80,ES_GA_Tracker=null,ES_GA_Usetime=null,MYuserAgent="Mozilla/5.0 (Linux; U; Android 4.2; EShare Build/KOT49H) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Mobile Safari/537.36/eshare",USER_LOGIN=!0;function WebviewInit(){doWebviewLayout();var t=document.querySelector("#amWebview");if(t.setUserAgentOverride(MYuserAgent),t.addEventListener("newwindow",(function(t){t.preventDefault(),processLocation(t.targetUrl)})),chrome.runtime.onMessage.addListener((function(t,e,o){if(t.detail){var i=t.detail;if(i.function&&("MagicBoardAppProxy.endMagicBoard"===i.function&&ShowMainpage("Board ended by host"),"MagicBoardAppProxy.handleAppRoleChanged"===i.function)){document.querySelector("#amWebview").executeScript({code:"var detail = {role:'' + detail.role + ''};var customEvent = new CustomEvent('MagicBoardAppProxy.handleAppRoleChanged', {'detail':detail});window.dispatchEvent(customEvent);"})}}})),document.querySelector("#back").onclick=function(){t.back()},document.querySelector("#forward").onclick=function(){t.forward()},document.querySelector("#home").onclick=function(){getHomeUrl((function(t){navigateTo(t)}))},document.querySelector("#reload").onclick=function(){isLoading?t.stop():t.reload()},document.querySelector("#reload").addEventListener("webkitAnimationIteration",(function(){isLoading||document.body.classList.remove("loading")})),document.querySelector("#bookmark").onclick=function(){addBookmark()},document.querySelector("#location-form").onsubmit=function(t){t.preventDefault(),processLocation(document.querySelector("#location").value)},t.addEventListener("exit",handleExit),t.addEventListener("loadstart",handleLoadStart),t.addEventListener("loadstop",handleLoadStop),t.addEventListener("loadabort",handleLoadAbort),t.addEventListener("loadredirect",handleLoadRedirect),t.addEventListener("loadcommit",handleLoadCommit),t.addEventListener("contentload",handleContentLoad),"function"==typeof t.setZoom&&"function"==typeof t.find){var e=!1;document.querySelector("#zoom-form").onsubmit=function(e){e.preventDefault();var o=document.forms["zoom-form"]["zoom-text"],i=Number(o.value);i>5?(o.value="5",i=5):i<.25&&(o.value="0.25",i=.25),t.setZoom(i)},document.querySelector("#zoom-in").onclick=function(t){t.preventDefault(),increaseZoom()},document.querySelector("#zoom-out").onclick=function(t){t.preventDefault(),decreaseZoom()},document.querySelector("#find-text").oninput=function(o){t.find(document.forms["find-form"]["find-text"].value,{matchCase:e})},document.querySelector("#find-text").onkeydown=function(e){event.ctrlKey&&13==event.keyCode&&(e.preventDefault(),t.stopFinding("activate"),closeFindBox())},document.querySelector("#match-case").onclick=function(o){o.preventDefault(),e=!e;var i=document.querySelector("#match-case");e?(i.style.color="blue",i.style["font-weight"]="bold"):(i.style.color="black",i.style["font-weight"]=""),t.find(document.forms["find-form"]["find-text"].value,{matchCase:e})},document.querySelector("#find-backward").onclick=function(o){o.preventDefault(),t.find(document.forms["find-form"]["find-text"].value,{backward:!0,matchCase:e})},document.querySelector("#find-form").onsubmit=function(o){o.preventDefault(),t.find(document.forms["find-form"]["find-text"].value,{matchCase:e})},t.addEventListener("findupdate",handleFindUpdate),window.addEventListener("keydown",handleKeyDown)}else{var o=document.querySelector("#zoom");o&&o.style&&(o.style.visibility="hidden",o.style.position="absolute");var i=document.querySelector("#find");i&&i.style&&(i.style.visibility="hidden",i.style.position="absolute")}}function navigateTo(t){resetExitedState(),document.querySelector("#amWebview").src=t}function doWebviewLayout(){if(chrome.app.window.get("ESClientMain")){document.querySelector("#amWebview"),document.querySelector("#webview_controls");getModeUrlScheme((function(t){var e=!1;""!==t&&(e=!0),$("#webview_controls").hasClass("backOnly")&&!e?($("#back").addClass("viewHide"),$("#forward").addClass("viewHide"),$("#home").addClass("viewHide"),$("#reload").addClass("viewHide"),$("#bookmark").addClass("viewHide"),$("#toMedia").addClass("viewHide"),$("#center-column").addClass("viewHide")):($("#back").removeClass("viewHide"),$("#forward").removeClass("viewHide"),$("#home").removeClass("viewHide"),$("#reload").removeClass("viewHide"),$("#bookmark").removeClass("viewHide"),$("#toMedia").removeClass("viewHide"),$("#center-column").removeClass("viewHide"))}));chrome.app.window.get("ESClientMain").innerBounds.width,chrome.app.window.get("ESClientMain").innerBounds.height}}function handleExit(t){document.body.classList.add("exited"),"exeception"==t.type?document.body.classList.add("crashed"):"killed"==t.type&&document.body.classList.add("killed")}function resetExitedState(){document.body.classList.remove("exited"),document.body.classList.remove("crashed"),document.body.classList.remove("killed")}function handleFindUpdate(t){var e=document.querySelector("#find-results");if(""===t.searchText?e.innerText="":e.innerText=t.activeMatchOrdinal+" of "+t.numberOfMatches,t.finalUpdate&&!t.canceled){var o=document.querySelector("#find-box");o.style.left="",o.style.opacity="";var i=o.getBoundingClientRect();if(findBoxObscuresActiveMatch(i,t.selectionRect)){var r=t.selectionRect.left-i.width-10;r>=5?o.style.left=r+"px":o.style.opacity="0.5"}}}function findBoxObscuresActiveMatch(t,e){return t.left<e.left+e.width&&t.right>e.left&&t.top<e.top+e.height&&t.bottom>e.top}function handleKeyDown(t){if(!$("#"+allView.Webview).hasClass("viewHide")&&t.ctrlKey)switch(t.keyCode){case 70:t.preventDefault(),"block"==document.querySelector("#find-box").style.display?(document.querySelector("#amWebview").stopFinding(),closeFindBox()):openFindBox();break;case 107:case 187:t.preventDefault(),increaseZoom();break;case 109:case 189:t.preventDefault(),decreaseZoom()}}function handleLoadCommit(t){if(resetExitedState(),t.isTopLevel){document.querySelector("#location").value=t.url;var e=document.querySelector("#amWebview");document.querySelector("#back").disabled=!e.canGoBack(),document.querySelector("#forward").disabled=!e.canGoForward(),closeBoxes()}}function handleLoadStart(t){document.body.classList.add("loading"),isLoading=!0,resetExitedState(),t.isTopLevel&&(document.querySelector("#location").value=t.url)}function processLocation(t){/^(https?:\/\/)?([\da-z\.-]+)\.([\da-z]{2,6}).*$/i.test(t)?navigateTo(/^(https?:\/\/)/i.test(t)?t:"http://"+t):navigateTo(("cloudvideo"===currentAF?"http://www.google.com/search?tbm=vid&q=":"http://www.google.com/m?q=")+t)}function processScheme(t){if(/eshare:\/\/eshare.app\/back/i.test(t)){var e=document.querySelector("#amWebview");document.getElementById("webview_container").removeChild(e),ShowMainpage()}else if(/eshare:\/\/eshare.app\/download/i.test(t)){var o=t.split("url=");if(o.length>1)decodeURIComponent(o[1])}else/emedia:\/\/eshare.app\/add/i.test(t)}function handleLoadStop(t){isLoading=!1,injectScriptParams()}function handleLoadAbort(t){processScheme(t.url)}function handleLoadRedirect(t){resetExitedState(),t.isTopLevel&&(document.querySelector("#location").value=t.newUrl)}function handleContentLoad(){var t=document.querySelector("#amWebview");t.executeScript({code:"window.addEventListener('message', function(e){   if(e.data.command == 'getTitle'){    e.source.postMessage({ title: document.title }, e.origin);  }});"}),t.contentWindow.postMessage({command:"getTitle"},"*")}function getNextPresetZoom(t){for(var e,o=[.25,.33,.5,.67,.75,.9,1,1.1,1.25,1.5,1.75,2,2.5,3,4,5],i=0,r=o.length-1;r-i>1;)if(o[e=Math.floor((r+i)/2)]<t)i=e;else{if(!(o[e]>t))return{low:o[e-1],high:o[e+1]};r=e}return{low:o[i],high:o[r]}}function increaseZoom(){var t=document.querySelector("#amWebview");t.getZoom((function(e){var o=getNextPresetZoom(e).high;t.setZoom(o),document.forms["zoom-form"]["zoom-text"].value=o.toString()}))}function decreaseZoom(){var t=document.querySelector("#amWebview");t.getZoom((function(e){var o=getNextPresetZoom(e).low;t.setZoom(o),document.forms["zoom-form"]["zoom-text"].value=o.toString()}))}function openZoomBox(){document.querySelector("#amWebview").getZoom((function(t){var e=document.forms["zoom-form"]["zoom-text"];e.value=Number(t.toFixed(6)).toString(),document.querySelector("#zoom-box").style.display="-webkit-flex",e.select()}))}function closeZoomBox(){document.querySelector("#zoom-box").style.display="none"}function openFindBox(){document.querySelector("#find-box").style.display="block",document.forms["find-form"]["find-text"].select()}function closeFindBox(){var t=document.querySelector("#find-box");t.style.display="none",t.style.left="",t.style.opacity="",document.querySelector("#find-results").innerText=""}function closeBoxes(){closeZoomBox(),closeFindBox()}function getHomeUrl(t){var e,o="";currentDevice&&(e="&type=null",currentDevice.Family&&(e="&type="+currentDevice.Family),currentDevice.Type&&("music"!==currentDevice.Type&&"lite"!==currentDevice.Type&&"car"!==currentDevice.Type||(e="&type=eshare"+currentDevice.Type)),o+=e,currentDevice.Hostname&&(o+="&ac="+encodeURIComponent(currentDevice.Hostname)),currentDevice.ID&&(o+="&da="+currentDevice.ID)),getModeUrlScheme((function(e){var i="";e&&(i=e);var r="https://"+i+"url.com/"+"webdefault.php?&tt=tb"+o;r+="&af="+currentAF,r+="&aa="+ES_HOST_MAC,r+="&av="+chrome.runtime.getManifest().version,r+="&app="+ESClientAppUniqueID,r+="&os=cros",r+="&al="+CountryCode,r+="&l="+chrome.i18n.getUILanguage(),md5_vm_test()&&(r+="&checksum="+hex_md5(currentDevice.ID+"\tbind")),t(r)}))}function getEMediaUrl(t){appendSchemeUrl("https://url.com",(function(e){t(e)}))}function getModeUrlScheme(t){chrome.storage.local.get("urlscheme",(function(e){t(e.urlscheme)}))}function appendSchemeUrl(t,e){getModeUrlScheme((function(o){var i=[t.slice(0,8),o,t.slice(8)].join("");e(i)}))}function injectScriptParams(){var t=document.querySelector("#amWebview");t.executeScript({file:"/jsbridge/jsContentScript.js"});var e=aiurJs+jsHandlerJs+bridgeJs+bridgeHandlerJs+webContentJs+("ES_INTERNAL_SERVER_URL='http://127.0.0.1:'"+ES_SERVER_PORT+"/service")+proxyJs;t.executeScript({code:generateScriptText(e)})}function playVisJS(t,e,o,i){document.querySelector("#amWebview").executeScript({code:"window[NAMESPACE]['background']['playlist'].play('' + src + '','' + title + '','' + image + '','' + type + '');"})}function addToEMedia(){}function addBookmark(){chrome.storage.local.get("ugcToken",(function(t){var e="https://url.com";e=(e=(e=e+"&app_id="+ES_HOST_MAC)+"&name="+encodeURIComponent(GuestPageTitle))+"&link="+encodeURIComponent(document.querySelector("#location").value),t&&t.ugcToken&&(e=e+"&token="+t.ugcToken),appendSchemeUrl(e=e+"&category="+("cloudvideo"===currentAF?"2":"1"),(function(t){try{var e=null;(e=new XMLHttpRequest).open("GET",t,!0),e.onreadystatechange=function(){4==e.readyState&&showMessageDlg("Bookmark Success")},e.send(null)}catch(t){}}))}))}function getQuality(t,e){chrome.storage.local.get("mirrorQuality",(function(o){setBtnQuality(o.mirrorQuality,t,e),initQualitySwitch(o.mirrorQuality),chrome.runtime.sendMessage({action:"setQuality",quality:"high"})}))}function initQualitySwitch(t){"low"===t&&document.getElementById("quality_switch").click()}function setBtnQuality(t,e,o){o?$("#btnQuality").show():$("#btnQuality").hide(),e?$("#btnQuality").removeClass("disable"):(t="high",$("#btnQuality").addClass("disable")),"low"===t?$("#btnQuality").addClass("active"):$("#btnQuality").removeClass("active")}function setbtn_eshare(t,e,o){getQuality(!0,o),o?($("#btn_eshare").show(),$("#btn_Reverse_share").show()):($("#btn_eshare").hide(),$("#btn_Reverse_share").hide()),e?$("#btn_eshare").removeClass("disable"):$("#btn_eshare").addClass("disable"),t?($("#btn_eshare").addClass("mirror"),$("#btn_eshare").css("display","none"),$("#btn_eshare_two").css("display","block"),$("#btn_eshare.mirror>span").html(chrome.i18n.getMessage("stop_mirroring")),$("#btn_Reverse_share").css("display","none"),$("#btn_eshare").css("float","none"),$("#btn_eshare_two").css("float","none"),$(".div_show").text(chrome.i18n.getMessage("ScreenIsShare"))):($("#btn_eshare").removeClass("mirror"),$("#btn_eshare").css("display","block"),$("#btn_eshare_two").css("display","none"),$("#btn_eshare>span").html(chrome.i18n.getMessage("start_mirroring")),$("#btn_Reverse_share").css("display","block"),$("#btn_eshare").css("float","left"),$("#btn_eshare_two").css("float","left"),$("#div_home_image").css("display","none"),$("#div_fullscreen_photo").css("background-image","url(/imgMainControl/ic_main_control_screen_full_pressed@3x.png)"),$("#btn_eshare_two_suspend").removeClass("continue"),$("#btn_eshare_two_suspend").css("background-image","url(/imagesAccount/ic_share_pause_normal@3x.png)"),$(".div_show").text(chrome.i18n.getMessage("Screenzhunbei")),$("#btn_Reverse_share>span").html(chrome.i18n.getMessage("tv_mirror")),$(".header").html(chrome.i18n.getMessage("connectdevice")),$("#table_trtdone").html(chrome.i18n.getMessage("device_name")),$("#table_trtdtwo").html(chrome.i18n.getMessage("adress_ip")),$("#button_id").html(chrome.i18n.getMessage("connect_immediately")),$("#P_device").html(chrome.i18n.getMessage("already_connect_device")),$("#network_name").css("display","none"),setTimeout((function(){if($(".list_table").find("tr").hasClass("table_tr"))return!1;$("#loading").empty(),$("#loading").addClass("loading_background")}),4100),chrome.app.window.current().restore())}function MainPageInit(){$("#btn_eshare.mirror>span").html(chrome.i18n.getMessage("stop_mirroring")),$("#btn_web>span").html(chrome.i18n.getMessage("web")),$("#btn_emedia>span").html(chrome.i18n.getMessage("emedia")),$("#btn_magicboard>span").html(chrome.i18n.getMessage("magicboard")),$("#btn_cloud_video>span").html(chrome.i18n.getMessage("cloud_video")),$("#btn_split_screen>span").html(chrome.i18n.getMessage("split_screen")),$("#btn_preference>span").html(chrome.i18n.getMessage("preference")),$("#btn_advanced>span").html(chrome.i18n.getMessage("advanced")),$("#btn_comment>span").html(chrome.i18n.getMessage("comment")),$("#btn_setting>span").html(chrome.i18n.getMessage("setting")),$("#btn_airsetup>span").html(chrome.i18n.getMessage("setting")),$("#myModalLabel").html(chrome.i18n.getMessage("password")),$("#passwordbutton").html(chrome.i18n.getMessage("Submit")),$("#passwordbuttoncancel").html(chrome.i18n.getMessage("cancel")),$("#ipNotPro_check").html(chrome.i18n.getMessage("Determine")),$("#myModalLabel").removeClass("myModalLabelcolor"),setupLoginUI(),setupOfflineMode()}function setupLoginUI(){USER_LOGIN?$("#user_acc_div").removeClass("viewHide"):$("#user_acc_div").addClass("viewHide")}function setupOfflineMode(){updateUIbyServiceImp()}function updateUIbyService(t){$("#main_container").removeClass("offline_mode"),updateUIbyServiceImp(t)}function updateUIbyServiceImp(t){var e={};for(var o in e="ESHAREPRO"===chrome.runtime.getManifest().product.toUpperCase()?{web:"enable",cloud_video:"enable",split_screen:"enable",comment:"enable",eshare:"enable",preference:"enable",advanced:"enable",bookmark:"enable"}:{web:"enable",setting:"enable",cloud_video:"enable",comment:"enable",eshare:"enable",bookmark:"enable"})$("#btn_"+o).removeClass("enable disable"),$("#btn_"+o).hide();for(var o in $.isEmptyObject(t)&&(t=e),t)$("#btn_"+o).removeClass("enable disable"),$("#btn_"+o).addClass(t[o]),"disable"!==t[o]&&$("#btn_"+o).show(),"eshare"===o&&setbtn_eshare($("#btn_eshare").hasClass("mirror")&&"enable"===t[o],"enable"===t[o],void 0!==t.eshare),"magicboard"===o&&chrome.runtime.sendMessage({uiAction:"updateEzBoardButton",show:t[o]})}function confirmCastCode(t){$("div#castcodeDialog").modal("hide");var e=$("#castcode").val();currentDevice.passcode===e?($("div#castcodeDialog").addClass("allow"),$("#castcode").val(""),chrome.runtime.sendMessage(t)):showMessageDlg("invalid castcode")}function OnNotifyPosition(t,e){var o=[{btnid:"#split1"},{btnid:"#split2"},{btnid:"#split3"},{btnid:"#split4"},{btnid:"#splitL"},{btnid:"#splitR"},{btnid:"#splitFull"}];for(var i in o)$(o[i].btnid).removeClass("active");4==t&&1==e&&$("#split1").addClass("active"),4==t&&2==e&&$("#split2").addClass("active"),4==t&&3==e&&$("#split3").addClass("active"),4==t&&4==e&&$("#split4").addClass("active"),2==t&&1==e&&$("#splitL").addClass("active"),2==t&&2==e&&$("#splitR").addClass("active"),1==t&&1==e&&$("#splitFull").addClass("active")}function RefreshPreference(){document.getElementById("CurrentDevice").innerHTML=currentDevice.Name,chrome.storage.local.get("UsePrefer",(function(t){t.UsePrefer&&(document.getElementById("CheckUsePrefer").checked=t.UsePrefer),SetPreferInfo(document.getElementById("CheckUsePrefer").checked)})),chrome.storage.local.get("NoDisturb",(function(t){t.NoDisturb&&(document.getElementById("CheckNoDisturb").checked=t.NoDisturb),ChkDoNotDisturb()})),chrome.storage.local.get("AutoAllow",(function(t){t.AutoAllow&&(document.getElementById("CheckAllowRequest").checked=t.AutoAllow),ChkAutoAllow()}))}function SetPreferInfo(t){document.getElementById("DeviceInfo").innerHTML=t?"<div id='PreferDeviceInfo' class='ui-widget-content ui-corner-all'>' + currentDevice.Name + '</div>":""}function ChkUsePrefer(){var t=document.getElementById("CheckUsePrefer").checked;SetPreferDevice(t,currentDevice.ID,currentDevice.Hostname),SetPreferInfo(t)}function ChkDoNotDisturb(){var t=document.getElementById("CheckNoDisturb").checked;document.getElementById("CheckAllowRequest").disabled=t,chrome.storage.local.set({NoDisturb:t}),chrome.runtime.sendMessage({action:"SetNoDisturb",value:t})}function ChkAutoAllow(){var t=document.getElementById("CheckAllowRequest").checked;chrome.storage.local.set({AutoAllow:t}),chrome.runtime.sendMessage({action:"SetAutoAllow",value:t})}function SetPreferDevice(t,e,o){chrome.storage.local.set({UsePrefer:t,preferDeviceID:e,preferDeviceName:o}),chrome.runtime.sendMessage({action:"SetUsePrefer",value:t})}function PreferenceInit(){$("#lblCurrDevice").html(chrome.i18n.getMessage("currentDevice")),$("#lblPreferDevice").html(chrome.i18n.getMessage("preferredDevice")),$("#lblUsePreferredDevice").html(chrome.i18n.getMessage("usePreferredDevice")),$("#lblHostControl").html(chrome.i18n.getMessage("hostcontrol")),$("#lblDND").html(chrome.i18n.getMessage("doNotDisturb")),$("#lblAutoAllow").html(chrome.i18n.getMessage("autoAllowRequest"))}function showGuestRequestDialog(t,e){var o=chrome.i18n.getMessage("allowRequest")+"<br>"+e;document.getElementById("es_modal-guestRequest")&&(document.getElementById("es_modal-guestRequest").checked=t,void 0!==o&&$("#es_request_content").html(o))}function showWaitHostDialog(t){document.getElementById("es_modal-waitHost")&&(document.getElementById("es_modal-waitHost").checked=t)}function showDeniedRequestDialog(t,e){document.getElementById("es_modal-denied-request")&&(document.getElementById("es_modal-denied-request").checked=t),$("#es_denied-request-message").html(e)}function HostControlInit(){$("#es_waitHost-message").html(chrome.i18n.getMessage("waitPermission"))}var hexcase=0,b64pad="";function hex_md5(t){return rstr2hex(rstr_md5(str2rstr_utf8(t)))}function b64_md5(t){return rstr2b64(rstr_md5(str2rstr_utf8(t)))}function any_md5(t,e){return rstr2any(rstr_md5(str2rstr_utf8(t)),e)}function hex_hmac_md5(t,e){return rstr2hex(rstr_hmac_md5(str2rstr_utf8(t),str2rstr_utf8(e)))}function b64_hmac_md5(t,e){return rstr2b64(rstr_hmac_md5(str2rstr_utf8(t),str2rstr_utf8(e)))}function any_hmac_md5(t,e,o){return rstr2any(rstr_hmac_md5(str2rstr_utf8(t),str2rstr_utf8(e)),o)}function md5_vm_test(){return"ab4cde67b72503267809ea8e52074cb4"==hex_md5("012345678901\tbind").toLowerCase()}function rstr_md5(t){return binl2rstr(binl_md5(rstr2binl(t),8*t.length))}function rstr_hmac_md5(t,e){var o=rstr2binl(t);o.length>16&&(o=binl_md5(o,8*t.length));for(var i=Array(16),r=Array(16),n=0;n<16;n++)i[n]=909522486^o[n],r[n]=1549556828^o[n];var s=binl_md5(i.concat(rstr2binl(e)),512+8*e.length);return binl2rstr(binl_md5(r.concat(s),640))}function rstr2hex(t){for(var e,o=hexcase?"0123456789ABCDEF":"0123456789abcdef",i="",r=0;r<t.length;r++)e=t.charCodeAt(r),i+=o.charAt(e>>>4&15)+o.charAt(15&e);return i}function rstr2b64(t){for(var e="",o=t.length,i=0;i<o;i+=3)for(var r=t.charCodeAt(i)<<16|(i+1<o?t.charCodeAt(i+1)<<8:0)|(i+2<o?t.charCodeAt(i+2):0),n=0;n<4;n++)8*i+6*n>8*t.length?e+=b64pad:e+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(r>>>6*(3-n)&63);return e}function rstr2any(t,e){var o,i,r,n,s,a=e.length,d=Array(Math.ceil(t.length/2));for(o=0;o<d.length;o++)d[o]=t.charCodeAt(2*o)<<8|t.charCodeAt(2*o+1);var c=Math.ceil(8*t.length/(Math.log(e.length)/Math.log(2))),l=Array(c);for(i=0;i<c;i++){for(s=Array(),n=0,o=0;o<d.length;o++)n=(n<<16)+d[o],n-=(r=Math.floor(n/a))*a,(s.length>0||r>0)&&(s[s.length]=r);l[i]=n,d=s}var h="";for(o=l.length-1;o>=0;o--)h+=e.charAt(l[o]);return h}function str2rstr_utf8(t){for(var e,o,i="",r=-1;++r<t.length;)e=t.charCodeAt(r),o=r+1<t.length?t.charCodeAt(r+1):0,55296<=e&&e<=56319&&56320<=o&&o<=57343&&(e=65536+((1023&e)<<10)+(1023&o),r++),e<=127?i+=String.fromCharCode(e):e<=2047?i+=String.fromCharCode(192|e>>>6&31,128|63&e):e<=65535?i+=String.fromCharCode(224|e>>>12&15,128|e>>>6&63,128|63&e):e<=2097151&&(i+=String.fromCharCode(240|e>>>18&7,128|e>>>12&63,128|e>>>6&63,128|63&e));return i}function str2rstr_utf16le(t){for(var e="",o=0;o<t.length;o++)e+=String.fromCharCode(255&t.charCodeAt(o),t.charCodeAt(o)>>>8&255);return e}function str2rstr_utf16be(t){for(var e="",o=0;o<t.length;o++)e+=String.fromCharCode(t.charCodeAt(o)>>>8&255,255&t.charCodeAt(o));return e}function rstr2binl(t){for(var e=Array(t.length>>2),o=0;o<e.length;o++)e[o]=0;for(var i=0;i<8*t.length;i+=8)e[i>>5]|=(255&t.charCodeAt(i/8))<<i%32;return e}function binl2rstr(t){for(var e="",o=0;o<32*t.length;o+=8)e+=String.fromCharCode(t[o>>5]>>>o%32&255);return e}function binl_md5(t,e){t[e>>5]|=128<<e%32,t[14+(e+64>>>9<<4)]=e;for(var o=1732584193,i=-271733879,r=-1732584194,n=271733878,s=0;s<t.length;s+=16){var a=o,d=i,c=r,l=n;o=md5_ff(o,i,r,n,t[s+0],7,-680876936),n=md5_ff(n,o,i,r,t[s+1],12,-389564586),r=md5_ff(r,n,o,i,t[s+2],17,606105819),i=md5_ff(i,r,n,o,t[s+3],22,-1044525330),o=md5_ff(o,i,r,n,t[s+4],7,-176418897),n=md5_ff(n,o,i,r,t[s+5],12,1200080426),r=md5_ff(r,n,o,i,t[s+6],17,-1473231341),i=md5_ff(i,r,n,o,t[s+7],22,-45705983),o=md5_ff(o,i,r,n,t[s+8],7,1770035416),n=md5_ff(n,o,i,r,t[s+9],12,-1958414417),r=md5_ff(r,n,o,i,t[s+10],17,-42063),i=md5_ff(i,r,n,o,t[s+11],22,-1990404162),o=md5_ff(o,i,r,n,t[s+12],7,1804603682),n=md5_ff(n,o,i,r,t[s+13],12,-40341101),r=md5_ff(r,n,o,i,t[s+14],17,-1502002290),o=md5_gg(o,i=md5_ff(i,r,n,o,t[s+15],22,1236535329),r,n,t[s+1],5,-165796510),n=md5_gg(n,o,i,r,t[s+6],9,-1069501632),r=md5_gg(r,n,o,i,t[s+11],14,643717713),i=md5_gg(i,r,n,o,t[s+0],20,-373897302),o=md5_gg(o,i,r,n,t[s+5],5,-701558691),n=md5_gg(n,o,i,r,t[s+10],9,38016083),r=md5_gg(r,n,o,i,t[s+15],14,-660478335),i=md5_gg(i,r,n,o,t[s+4],20,-405537848),o=md5_gg(o,i,r,n,t[s+9],5,568446438),n=md5_gg(n,o,i,r,t[s+14],9,-1019803690),r=md5_gg(r,n,o,i,t[s+3],14,-187363961),i=md5_gg(i,r,n,o,t[s+8],20,1163531501),o=md5_gg(o,i,r,n,t[s+13],5,-1444681467),n=md5_gg(n,o,i,r,t[s+2],9,-51403784),r=md5_gg(r,n,o,i,t[s+7],14,1735328473),o=md5_hh(o,i=md5_gg(i,r,n,o,t[s+12],20,-1926607734),r,n,t[s+5],4,-378558),n=md5_hh(n,o,i,r,t[s+8],11,-2022574463),r=md5_hh(r,n,o,i,t[s+11],16,1839030562),i=md5_hh(i,r,n,o,t[s+14],23,-35309556),o=md5_hh(o,i,r,n,t[s+1],4,-1530992060),n=md5_hh(n,o,i,r,t[s+4],11,1272893353),r=md5_hh(r,n,o,i,t[s+7],16,-155497632),i=md5_hh(i,r,n,o,t[s+10],23,-1094730640),o=md5_hh(o,i,r,n,t[s+13],4,681279174),n=md5_hh(n,o,i,r,t[s+0],11,-358537222),r=md5_hh(r,n,o,i,t[s+3],16,-722521979),i=md5_hh(i,r,n,o,t[s+6],23,76029189),o=md5_hh(o,i,r,n,t[s+9],4,-640364487),n=md5_hh(n,o,i,r,t[s+12],11,-421815835),r=md5_hh(r,n,o,i,t[s+15],16,530742520),o=md5_ii(o,i=md5_hh(i,r,n,o,t[s+2],23,-995338651),r,n,t[s+0],6,-198630844),n=md5_ii(n,o,i,r,t[s+7],10,1126891415),r=md5_ii(r,n,o,i,t[s+14],15,-1416354905),i=md5_ii(i,r,n,o,t[s+5],21,-57434055),o=md5_ii(o,i,r,n,t[s+12],6,1700485571),n=md5_ii(n,o,i,r,t[s+3],10,-1894986606),r=md5_ii(r,n,o,i,t[s+10],15,-1051523),i=md5_ii(i,r,n,o,t[s+1],21,-2054922799),o=md5_ii(o,i,r,n,t[s+8],6,1873313359),n=md5_ii(n,o,i,r,t[s+15],10,-30611744),r=md5_ii(r,n,o,i,t[s+6],15,-1560198380),i=md5_ii(i,r,n,o,t[s+13],21,1309151649),o=md5_ii(o,i,r,n,t[s+4],6,-145523070),n=md5_ii(n,o,i,r,t[s+11],10,-1120210379),r=md5_ii(r,n,o,i,t[s+2],15,718787259),i=md5_ii(i,r,n,o,t[s+9],21,-343485551),o=safe_add(o,a),i=safe_add(i,d),r=safe_add(r,c),n=safe_add(n,l)}return Array(o,i,r,n)}function md5_cmn(t,e,o,i,r,n){return safe_add(bit_rol(safe_add(safe_add(e,t),safe_add(i,n)),r),o)}function md5_ff(t,e,o,i,r,n,s){return md5_cmn(e&o|~e&i,t,e,r,n,s)}function md5_gg(t,e,o,i,r,n,s){return md5_cmn(e&i|o&~i,t,e,r,n,s)}function md5_hh(t,e,o,i,r,n,s){return md5_cmn(e^o^i,t,e,r,n,s)}function md5_ii(t,e,o,i,r,n,s){return md5_cmn(o^(e|~i),t,e,r,n,s)}function safe_add(t,e){var o=(65535&t)+(65535&e);return(t>>16)+(e>>16)+(o>>16)<<16|65535&o}function bit_rol(t,e){return t<<e|t>>>32-e}var MirrorView=!1;!function(){"use strict";var t=function(t){var e=t||{},o={provider:function(){throw new Error("No provider!")},maxLength:30,onUpdate:function(){}};this.provider=void 0!==e.provider?e.provider:o.provider,this.maxLength=void 0!==e.maxLength?e.maxLength:o.maxLength,this.onUpdate=void 0!==e.onUpdate?e.onUpdate:o.onUpdate,this.initialItem=null,this.clear()};t.prototype.initialize=function(t){this.stack[0]=t,this.initialItem=t},t.prototype.clear=function(){this.stack=[this.initialItem],this.position=0,this.onUpdate()},t.prototype.save=function(){this.provider(function(t){!function(t,e){for(;t.length>e;)t.shift()}(this.stack,this.maxLength),this.position=Math.min(this.position,this.stack.length-1),this.stack=this.stack.slice(0,this.position+1),this.stack.push(t),this.position++,this.onUpdate()}.bind(this))},t.prototype.undo=function(t){if(this.canUndo()){var e=this.stack[--this.position];this.onUpdate(),t&&t(e)}},t.prototype.redo=function(t){if(this.canRedo()){var e=this.stack[++this.position];this.onUpdate(),t&&t(e)}},t.prototype.canUndo=function(){return this.position>0},t.prototype.canRedo=function(){return this.position<this.count()},t.prototype.count=function(){return this.stack.length-1},"undefined"!=typeof module&&(module.exports=t),"undefined"!=typeof window&&(window.SimpleUndo=t)}(),window.DrawingBoard="undefined"!=typeof DrawingBoard?DrawingBoard:{},DrawingBoard.Utils={},
/*!
* Tim (lite)
*   github.com/premasagar/tim
*/
DrawingBoard.Utils.tpl=function(){"use strict";var t=new RegExp("{{\\s*([a-z0-9_][\\.a-z0-9_]*)\\s*}}","gi");return function(e,o){return e.replace(t,(function(t,e){for(var i=e.split("."),r=i.length,n=o,s=0;s<r;s++){if(undefined===(n=n[i[s]]))throw"tim: '"+i[s]+"' not found in "+t;if(s===r-1)return n}}))}}(),DrawingBoard.Utils.MicroEvent=function(){},DrawingBoard.Utils.MicroEvent.prototype={bind:function(t,e){this._events=this._events||{},this._events[t]=this._events[t]||[],this._events[t].push(e)},unbind:function(t,e){this._events=this._events||{},t in this._events!=!1&&this._events[t].splice(this._events[t].indexOf(e),1)},trigger:function(t){if(this._events=this._events||{},t in this._events!=!1)for(var e=0;e<this._events[t].length;e++)this._events[t][e].apply(this,Array.prototype.slice.call(arguments,1))}},DrawingBoard.Utils._boxBorderSize=function(t,e,o,i){e=!!e||!0,o=!!o||!1;var r,n=0;"width"==i?(r=["border-left-width","border-right-width"],e&&r.push("padding-left","padding-right"),o&&r.push("margin-left","margin-right")):(r=["border-top-width","border-bottom-width"],e&&r.push("padding-top","padding-bottom"),o&&r.push("margin-top","margin-bottom"));for(var s=r.length-1;s>=0;s--)n+=parseInt(t.css(r[s]).replace("px",""),10);return n},DrawingBoard.Utils.boxBorderWidth=function(t,e,o){return DrawingBoard.Utils._boxBorderSize(t,e,o,"width")},DrawingBoard.Utils.boxBorderHeight=function(t,e,o){return DrawingBoard.Utils._boxBorderSize(t,e,o,"height")},DrawingBoard.Utils.isColor=function(t){return!(!t||!t.length)&&(/(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i.test(t)||-1!==$.inArray(t.substring(0,3),["rgb","hsl"]))},DrawingBoard.Utils.RGBToInt=function(t,e,o){var i=0;return i|=(255&t)<<16,i|=(255&e)<<8,i|=255&o},DrawingBoard.Utils.pixelAt=function(t,e,o){var i=4*(o*t.width+e);return[i,e,o,DrawingBoard.Utils.RGBToInt(t.data[i],t.data[i+1],t.data[i+2])]},DrawingBoard.Utils.compareColors=function(t,e,o){if(0===o)return t===e;var i=t>>16&255,r=e>>16&255,n=t>>8&255,s=e>>8&255,a=255&t,d=255&e;return Math.abs(i-r)<=o&&Math.abs(n-s)<=o&&Math.abs(a-d)<=o},function(){for(var t=["ms","moz","webkit","o"],e=0;e<t.length&&!window.requestAnimationFrame;++e)window.requestAnimationFrame=window[t[e]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[e]+"CancelAnimationFrame"]||window[t[e]+"CancelRequestAnimationFrame"]}(),window.DrawingBoard="undefined"!=typeof DrawingBoard?DrawingBoard:{},DrawingBoard.Board=function(t,e){if(this.opts=this.mergeOptions(e),this.ev=new DrawingBoard.Utils.MicroEvent,this.id=t,this.$el=$(document.getElementById(t)),!this.$el.length)return!1;var o='<div class="drawing-board-canvas-wrapper"></canvas><canvas class="drawing-board-canvas"></canvas><div class="drawing-board-cursor drawing-board-utils-hidden"></div></div>';if(this.opts.controlsPosition.indexOf("bottom")>-1?o+='<div class="drawing-board-controls"></div>':o='<div class="drawing-board-controls"></div>'+o,this.$el.addClass("drawing-board").append(o),this.dom={$canvasWrapper:this.$el.find(".drawing-board-canvas-wrapper"),$canvas:this.$el.find(".drawing-board-canvas"),$cursor:this.$el.find(".drawing-board-cursor"),$controls:this.$el.find(".drawing-board-controls"),$sizeheight:" ",$sizewidth:" "},$.each(["left","right","center"],$.proxy((function(t,e){if(this.opts.controlsPosition.indexOf(e)>-1)return this.dom.$controls.attr("data-align",e),!1}),this)),this.canvas=this.dom.$canvas.get(0),this.ctx=this.canvas&&this.canvas.getContext&&this.canvas.getContext("2d")?this.canvas.getContext("2d"):null,this.color=this.opts.color,!this.ctx)return this.opts.errorMessage&&this.$el.html(this.opts.errorMessage),!1;this.storage=this._getStorage(),this.initHistory(),this.reset({webStorage:!1,history:!1,background:!1}),this.initControls(),this.resize(),this.reset({webStorage:!1,history:!1,background:!0}),this.restoreWebStorage(),this.initDropEvents(),this.initDrawEvents()},DrawingBoard.Board.defaultOpts={controls:["Color","DrawingMode","Size","Navigation"],controlsPosition:"top left",color:"#000000",size:1,background:"#fff",eraserColor:"background",fillTolerance:100,fillHack:!0,webStorage:"session",droppable:!1,enlargeYourContainer:!1,errorMessage:'<p>It seems you use an obsolete browser. <a href="http://browsehappy.com/" target="_blank">Update it</a> to start drawing.</p>',stretchImg:!1,sendcolor:-3916011},DrawingBoard.Board.prototype={mergeOptions:function(t){return(t=$.extend({},DrawingBoard.Board.defaultOpts,t)).background||"background"!==t.eraserColor||(t.eraserColor="transparent"),t},reset:function(t){t=$.extend({color:this.opts.color,size:this.opts.size,webStorage:!0,history:!0,background:!1},t),this.setMode("pencil"),t.background&&this.resetBackground(this.opts.background,$.proxy((function(){t.history&&this.saveHistory()}),this)),t.color&&this.setColor(t.color),t.size&&(this.ctx.lineWidth=t.size),this.ctx.lineCap="round",this.ctx.lineJoin="round",t.webStorage&&this.saveWebStorage(),t.history&&!t.background&&this.saveHistory(),this.blankCanvas=this.getImg(),this.ev.trigger("board:reset",t)},resetBackground:function(t,e){t=t||this.opts.background;var o=DrawingBoard.Utils.isColor(t),i=this.getMode();this.setMode("pencil"),this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),o?(this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.history.initialize(this.getImg()),e&&e()):t&&this.setImg(t,{callback:$.proxy((function(){this.history.initialize(this.getImg()),e&&e()}),this)}),this.setMode(i)},removepencil:function(){this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)},resetsize:function(t){this.ctx.lineWidth=t,this.opts.size=t},resetsendcolor:function(t){this.opts.sendcolor=t},resize:function(){var t,e;this.dom.$controls.toggleClass("drawing-board-controls-hidden",!this.controls||!this.controls.length);var o=[this.$el.width(),DrawingBoard.Utils.boxBorderWidth(this.$el),DrawingBoard.Utils.boxBorderWidth(this.dom.$canvasWrapper,!0,!0)],i=[this.$el.height(),DrawingBoard.Utils.boxBorderHeight(this.$el),this.dom.$controls.height(),DrawingBoard.Utils.boxBorderHeight(this.dom.$controls,!1,!0),DrawingBoard.Utils.boxBorderHeight(this.dom.$canvasWrapper,!0,!0)],r=function(t,e){e=e||1;for(var o=t[0],i=1;i<t.length;i++)o+=t[i]*e;return o},n=function(t){return r(t,-1)};this.opts.enlargeYourContainer?(t=this.dom.$canvasWrapper.width(),e=this.dom.$canvasWrapper.height(),this.$el.width(r(o)),this.$el.height(r(i))):(t=n(o),e=n(i)),this.dom.$canvasWrapper.css({position:"absoulte",bottom:"0px",width:"100%",height:"100%"}),this.dom.$canvas.css({position:"absoulte",bottom:"0px",width:"100%",height:"100%"}),this.canvas.width=t,this.canvas.height=e},initControls:function(){if(this.controls=[],!this.opts.controls.length||!DrawingBoard.Control)return!1;for(var t=0;t<this.opts.controls.length;t++){var e=null;if("string"==typeof this.opts.controls[t])e=new window.DrawingBoard.Control[this.opts.controls[t]](this);else if("object"==typeof this.opts.controls[t]){for(var o in this.opts.controls[t])break;e=new window.DrawingBoard.Control[o](this,this.opts.controls[t][o])}e&&this.addControl(e)}},addControl:function(t,e,o){if("string"!=typeof t&&("object"!=typeof t||!t instanceof DrawingBoard.Control))return!1;var i="object"==typeof e?e:{};o=o?1*o:"number"==typeof e?e:null,"string"==typeof t&&(t=new window.DrawingBoard.Control[t](this,i)),o?this.dom.$controls.children().eq(o).before(t.$el):this.dom.$controls.append(t.$el),this.controls||(this.controls=[]),this.controls.push(t),this.dom.$controls.removeClass("drawing-board-controls-hidden")},initHistory:function(){this.history=new SimpleUndo({maxLength:30,provider:$.proxy((function(t){t(this.getImg())}),this),onUpdate:$.proxy((function(){this.ev.trigger("historyNavigation")}),this)})},saveHistory:function(){this.history.save()},restoreHistory:function(t){this.setImg(t,{callback:$.proxy((function(){this.saveWebStorage()}),this)})},goBackInHistory:function(){this.history.undo($.proxy(this.restoreHistory,this))},goForthInHistory:function(){this.history.redo($.proxy(this.restoreHistory,this))},setImg:function(t,e){e=$.extend({stretch:this.opts.stretchImg,callback:null},e);var o=this.ctx,i=new Image,r=o.globalCompositeOperation;i.onload=function(){o.globalCompositeOperation="source-over",o.clearRect(0,0,o.canvas.width,o.canvas.height),e.stretch?o.drawImage(i,0,0,o.canvas.width,o.canvas.height):o.drawImage(i,0,0),o.globalCompositeOperation=r,e.callback&&e.callback()},i.src=t},getImg:function(){return this.canvas.toDataURL("image/png")},downloadImg:function(){var t=this.getImg();t=t.replace("image/png","image/octet-stream"),window.location.href=t},saveWebStorage:function(){window[this.storage]&&(window[this.storage].setItem("drawing-board-"+this.id,this.getImg()),this.ev.trigger("board:save"+this.storage.charAt(0).toUpperCase()+this.storage.slice(1),this.getImg()))},restoreWebStorage:function(){window[this.storage]&&null!==window[this.storage].getItem("drawing-board-"+this.id)&&(this.setImg(window[this.storage].getItem("drawing-board-"+this.id)),this.ev.trigger("board:restore"+this.storage.charAt(0).toUpperCase()+this.storage.slice(1),window[this.storage].getItem("drawing-board-"+this.id)))},clearWebStorage:function(){window[this.storage]&&null!==window[this.storage].getItem("drawing-board-"+this.id)&&(window[this.storage].removeItem("drawing-board-"+this.id),this.ev.trigger("board:clear"+this.storage.charAt(0).toUpperCase()+this.storage.slice(1)))},_getStorage:function(){return!(!this.opts.webStorage||"session"!==this.opts.webStorage&&"local"!==this.opts.webStorage)&&this.opts.webStorage+"Storage"},initDropEvents:function(){if(!this.opts.droppable)return!1;this.dom.$canvas.on("dragover dragenter drop",(function(t){t.stopPropagation(),t.preventDefault()})),this.dom.$canvas.on("drop",$.proxy(this._onCanvasDrop,this))},_onCanvasDrop:function(t){var e=(t=t.originalEvent?t.originalEvent:t).dataTransfer.files;if(!e||!e.length||-1==e[0].type.indexOf("image")||!window.FileReader)return!1;var o=new FileReader;o.readAsDataURL(e[0]),o.onload=$.proxy((function(t){this.setImg(t.target.result,{callback:$.proxy((function(){this.saveHistory()}),this)}),this.ev.trigger("board:imageDropped",t.target.result),this.ev.trigger("board:userAction")}),this)},setMode:function(t,e){e=e||!1,t=t||"pencil",this.ev.unbind("board:startDrawing",$.proxy(this.fill,this)),"transparent"===this.opts.eraserColor?this.ctx.globalCompositeOperation="eraser"===t?"destination-out":"source-over":("eraser"===t?"background"===this.opts.eraserColor&&DrawingBoard.Utils.isColor(this.opts.background)?this.ctx.strokeStyle=this.opts.background:DrawingBoard.Utils.isColor(this.opts.eraserColor)&&(this.ctx.strokeStyle=this.opts.eraserColor):this.mode&&"eraser"!==this.mode||(this.ctx.strokeStyle=this.color),"filler"===t&&this.ev.bind("board:startDrawing",$.proxy(this.fill,this))),this.mode=t,e||this.ev.trigger("board:mode",this.mode)},getMode:function(){return this.mode||"pencil"},setColor:function(t){var e=this;if(t=t||this.color,!DrawingBoard.Utils.isColor(t))return!1;if(this.color=t,"transparent"!==this.opts.eraserColor&&"eraser"===this.mode){var o=function(t){"eraser"!==t&&(e.strokeStyle=e.color),e.ev.unbind("board:mode",o)};this.ev.bind("board:mode",o)}else this.ctx.strokeStyle=this.color},fill:function(t){if(this.getImg()===this.blankCanvas)return this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.fillStyle=this.color,void this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height);var e=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height),o=this.ctx.strokeStyle,i=parseInt(o.substr(1,2),16),r=parseInt(o.substr(3,2),16),n=parseInt(o.substr(5,2),16),s=DrawingBoard.Utils.pixelAt(e,parseInt(t.coords.x,10),parseInt(t.coords.y,10)),a=s[3],d=this.opts.fillTolerance,c=this.opts.fillHack;if(!DrawingBoard.Utils.compareColors(a,DrawingBoard.Utils.RGBToInt(i,r,n),d)){for(var l,h=[s],u=e.width-1,g=e.height-1;l=h.pop();)c&&m(l),DrawingBoard.Utils.compareColors(l[3],a,d)&&(c||m(l),l[1]>0&&h.push(DrawingBoard.Utils.pixelAt(e,l[1]-1,l[2])),l[1]<u&&h.push(DrawingBoard.Utils.pixelAt(e,l[1]+1,l[2])),l[2]>0&&h.push(DrawingBoard.Utils.pixelAt(e,l[1],l[2]-1)),l[2]<g&&h.push(DrawingBoard.Utils.pixelAt(e,l[1],l[2]+1)));this.ctx.putImageData(e,0,0)}function m(t){e.data[t[0]]=i,e.data[t[0]+1]=r,e.data[t[0]+2]=n}},initDrawEvents:function(){this.isDrawing=!1,this.isMouseHovering=!1,this.isstart=!1,this.coords={},this.coords.old=this.coords.current=this.coords.oldMid={x:0,y:0},this.dom.$canvas.on("mousedown touchstart",$.proxy((function(t){this._onInputStart(t,this._getInputCoords(t)),chrome.runtime.sendMessage({action:"drawPen",size:this.opts.size+3,color:this.opts.sendcolor}),chrome.runtime.sendMessage({action:"drawMsg",x:1280*this._getInputCoords(t).x/this.dom.$canvas.width(),y:720*this._getInputCoords(t).y/this.dom.$canvas.height(),actionStatus:0}),this.isstart=!0,this.settime&&clearTimeout(this.settime)}),this)),this.dom.$canvas.on("mousemove touchmove",$.proxy((function(t){this._onInputMove(t,this._getInputCoords(t)),this.isstart&&chrome.runtime.sendMessage({action:"drawMsg",x:1280*this._getInputCoords(t).x/this.dom.$canvas.width(),y:720*this._getInputCoords(t).y/this.dom.$canvas.height(),actionStatus:2})}),this)),this.dom.$canvas.on("mousemove",$.proxy((function(t){}),this)),this.dom.$canvas.on("mouseup touchend",$.proxy((function(t){this._onInputStop(t,this._getInputCoords(t)),this.isstart=!1,chrome.runtime.sendMessage({action:"drawMsg",x:1280*this._getInputCoords(t).x/this.dom.$canvas.width(),y:720*this._getInputCoords(t).y/this.dom.$canvas.height(),actionStatus:1}),this.settime=setTimeout(function(){this.isstart,this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}.bind(this),1500)}),this)),this.dom.$canvas.on("mouseover",$.proxy((function(t){this._onMouseOver(t,this._getInputCoords(t))}),this)),this.dom.$canvas.on("mouseout",$.proxy((function(t){this._onMouseOut(t,this._getInputCoords(t)),this.isstart&&(this._onInputStop(t,this._getInputCoords(t)),this.isstart=!1,chrome.runtime.sendMessage({action:"drawMsg",x:1280*this._getInputCoords(t).x/this.dom.$canvas.width(),y:720*this._getInputCoords(t).y/this.dom.$canvas.height(),actionStatus:1}),this.settime=setTimeout(function(){this.isstart,this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}.bind(this),1500))}),this)),$("body").on("mouseup touchend",$.proxy((function(t){this.isDrawing=!1}),this)),window.requestAnimationFrame&&requestAnimationFrame($.proxy(this.draw,this))},draw:function(){if(window.requestAnimationFrame&&this.ctx.lineWidth>10&&this.isMouseHovering){this.dom.$cursor.css({width:this.ctx.lineWidth+"px",height:this.ctx.lineWidth+"px"});var t=DrawingBoard.Utils.tpl("translateX({{x}}px) translateY({{y}}px)",{x:this.coords.current.x-this.ctx.lineWidth/2,y:this.coords.current.y-this.ctx.lineWidth/2});this.dom.$cursor.css({transform:t,"-webkit-transform":t,"-ms-transform":t}),this.dom.$cursor.removeClass("drawing-board-utils-hidden")}else this.dom.$cursor.addClass("drawing-board-utils-hidden");if(this.isDrawing){var e=this._getMidInputCoords(this.coords.current);this.ctx.beginPath(),chrome.app.window.get("tvMirrorsWinodw").isMaximized()||($sizeheight=$("#returnsimg").height(),$sizewidth=$("#returnsimg").width()),this.ctx.moveTo(e.x*$sizewidth/this.dom.$canvas.width(),e.y*$sizeheight/this.dom.$canvas.height()),this.ctx.quadraticCurveTo(this.coords.old.x*$sizewidth/this.dom.$canvas.width(),this.coords.old.y*$sizeheight/this.dom.$canvas.height(),this.coords.oldMid.x*$sizewidth/this.dom.$canvas.width(),this.coords.oldMid.y*$sizeheight/this.dom.$canvas.height()),this.ctx.stroke(),this.coords.old=this.coords.current,this.coords.oldMid=e}window.requestAnimationFrame&&requestAnimationFrame($.proxy((function(){this.draw()}),this))},_onInputStart:function(t,e){this.coords.current=this.coords.old=e,this.coords.oldMid=this._getMidInputCoords(e),this.isDrawing=!0,window.requestAnimationFrame||this.draw(),this.ev.trigger("board:startDrawing",{e:t,coords:e}),t.stopPropagation(),t.preventDefault()},_onInputMove:function(t,e){this.coords.current=e,this.ev.trigger("board:drawing",{e:t,coords:e}),window.requestAnimationFrame||this.draw(),t.stopPropagation(),t.preventDefault()},_onInputStop:function(t,e){!this.isDrawing||t.touches&&0!==t.touches.length||(this.isDrawing=!1,this.saveWebStorage(),this.saveHistory(),this.ev.trigger("board:stopDrawing",{e:t,coords:e}),this.ev.trigger("board:userAction"),t.stopPropagation(),t.preventDefault())},_onMouseOver:function(t,e){this.isMouseHovering=!0,this.coords.old=this._getInputCoords(t),this.coords.oldMid=this._getMidInputCoords(this.coords.old),this.ev.trigger("board:mouseOver",{e:t,coords:e})},_onMouseOut:function(t,e){this.isMouseHovering=!1,this.ev.trigger("board:mouseOut",{e:t,coords:e})},_getInputCoords:function(t){t=t.originalEvent?t.originalEvent:t;var e,o,i=this.canvas.getBoundingClientRect(),r=this.dom.$canvas.width(),n=this.dom.$canvas.height();return t.touches&&1==t.touches.length&&(e=t.touches[0].pageX,o=t.touches[0].pageY),t.changedTouches&&1==t.changedTouches.length?(e=t.changedTouches[0].pageX,o=t.changedTouches[0].pageY):(e=t.pageX,o=t.pageY),e-=this.dom.$canvas.offset().left,o-=this.dom.$canvas.offset().top,{x:e*=r/i.width,y:o*=n/i.height}},_getMidInputCoords:function(t){return{x:this.coords.old.x+t.x>>1,y:this.coords.old.y+t.y>>1}}},DrawingBoard.Control=function(t,e){return this.board=t,this.opts=$.extend({},this.defaults,e),this.$el=$(document.createElement("div")).addClass("drawing-board-control"),this.name&&this.$el.addClass("drawing-board-control-"+this.name),this.board.ev.bind("board:reset",$.proxy(this.onBoardReset,this)),this.initialize.apply(this,arguments),this},DrawingBoard.Control.prototype={name:"",defaults:{},initialize:function(){},addToBoard:function(){this.board.addControl(this)},onBoardReset:function(t){}},DrawingBoard.Control.extend=function(t,e){var o,i=this;o=t&&t.hasOwnProperty("constructor")?t.constructor:function(){return i.apply(this,arguments)},$.extend(o,i,e);var r=function(){this.constructor=o};return r.prototype=i.prototype,o.prototype=new r,t&&$.extend(o.prototype,t),o.__super__=i.prototype,o},DrawingBoard.Control.Color=DrawingBoard.Control.extend({name:"colors",initialize:function(){this.initTemplate();var t=this;this.$el.on("click",".drawing-board-control-colors-picker",(function(e){var o=$(this).attr("data-color");t.board.setColor(o),t.$el.find(".drawing-board-control-colors-current").css("background-color",o).attr("data-color",o),t.board.ev.trigger("color:changed",o),t.$el.find(".drawing-board-control-colors-rainbows").addClass("drawing-board-utils-hidden"),e.preventDefault()})),this.$el.on("click",".drawing-board-control-colors-current",(function(e){t.$el.find(".drawing-board-control-colors-rainbows").toggleClass("drawing-board-utils-hidden"),e.preventDefault()})),$("body").on("click",(function(e){var o=$(e.target),i=o.hasClass("drawing-board-control-colors-current")?o:o.closest(".drawing-board-control-colors-current"),r=t.$el.find(".drawing-board-control-colors-current"),n=t.$el.find(".drawing-board-control-colors-rainbows");i.length&&i.get(0)===r.get(0)||n.hasClass("drawing-board-utils-hidden")||n.addClass("drawing-board-utils-hidden")}))},initTemplate:function(){var t='<div class="drawing-board-control-colors-picker" data-color="{{color}}" style="background-color: {{color}}"></div>',e="";$.each([.75,.5,.25],$.proxy((function(o,i){var r=0,n=null;for(e+='<div class="drawing-board-control-colors-rainbow">',.25==i&&(n=this._rgba(0,0,0,1)),.5==i&&(n=this._rgba(150,150,150,1)),.75==i&&(n=this._rgba(255,255,255,1)),e+=DrawingBoard.Utils.tpl(t,{color:n.toString()});r<=330;)e+=DrawingBoard.Utils.tpl(t,{color:this._hsl2Rgba(this._hsl(r-60,1,i)).toString()}),r+=30;e+="</div>"}),this)),this.$el.append($(DrawingBoard.Utils.tpl('<div class="drawing-board-control-inner"><div class="drawing-board-control-colors-current" style="background-color: {{color}}" data-color="{{color}}"></div><div class="drawing-board-control-colors-rainbows">{{rainbows}}</div></div>',{color:this.board.color,rainbows:e}))),this.$el.find(".drawing-board-control-colors-rainbows").addClass("drawing-board-utils-hidden")},onBoardReset:function(t){this.board.setColor(this.$el.find(".drawing-board-control-colors-current").attr("data-color"))},_rgba:function(t,e,o,i){return{r:t,g:e,b:o,a:i,toString:function(){return"rgba("+t+", "+e+", "+o+", "+i+")"}}},_hsl:function(t,e,o){return{h:t,s:e,l:o,toString:function(){return"hsl("+t+", "+100*e+"%, "+100*o+"%)"}}},_hex2Rgba:function(t){var e=parseInt(t.substring(1),16);return this._rgba(e>>16,e>>8&255,255&e,1)},_hsl2Rgba:function(t){var e,o,i,r=t.h/360,n=t.s,s=t.l;function a(t,e,o){return o<0&&(o+=1),o>1&&(o-=1),o<1/6?t+6*(e-t)*o:o<.5?e:o<2/3?t+(e-t)*(2/3-o)*6:t}if(0===n)e=o=i=s;else{var d=s<.5?s*(1+n):s+n-s*n,c=2*s-d;e=Math.floor(255*a(c,d,r+1/3)),o=Math.floor(255*a(c,d,r)),i=Math.floor(255*a(c,d,r-1/3))}return this._rgba(e,o,i,1)}}),DrawingBoard.Control.DrawingMode=DrawingBoard.Control.extend({name:"drawingmode",defaults:{pencil:!0,eraser:!0,filler:!0},initialize:function(){this.prevMode=this.board.getMode(),$.each(["pencil","eraser","filler"],$.proxy((function(t,e){this.opts[e]&&this.$el.append('<button class="drawing-board-control-drawingmode-'+e+'-button" data-mode="'+e+'"></button>')}),this)),this.$el.on("click","button[data-mode]",$.proxy((function(t){var e=$(t.currentTarget).attr("data-mode"),o=this.board.getMode();o!==e&&(this.prevMode=o);var i=o===e?this.prevMode:e;this.board.setMode(i),t.preventDefault()}),this)),this.board.ev.bind("board:mode",$.proxy((function(t){this.toggleButtons(t)}),this)),this.toggleButtons(this.board.getMode())},toggleButtons:function(t){this.$el.find("button[data-mode]").each((function(e,o){var i=$(o);i.toggleClass("active",t===i.attr("data-mode"))}))}}),DrawingBoard.Control.Navigation=DrawingBoard.Control.extend({name:"navigation",defaults:{back:!0,forward:!0,reset:!0},initialize:function(){var t="";if(this.opts.back&&(t+='<button class="drawing-board-control-navigation-back">&larr;</button>'),this.opts.forward&&(t+='<button class="drawing-board-control-navigation-forward">&rarr;</button>'),this.opts.reset&&(t+='<button class="drawing-board-control-navigation-reset">&times;</button>'),this.$el.append(t),this.opts.back){var e=this.$el.find(".drawing-board-control-navigation-back");this.board.ev.bind("historyNavigation",$.proxy(this.updateBack,this,e)),this.$el.on("click",".drawing-board-control-navigation-back",$.proxy((function(t){this.board.goBackInHistory(),t.preventDefault()}),this)),this.updateBack(e)}if(this.opts.forward){var o=this.$el.find(".drawing-board-control-navigation-forward");this.board.ev.bind("historyNavigation",$.proxy(this.updateForward,this,o)),this.$el.on("click",".drawing-board-control-navigation-forward",$.proxy((function(t){this.board.goForthInHistory(),t.preventDefault()}),this)),this.updateForward(o)}this.opts.reset&&this.$el.on("click",".drawing-board-control-navigation-reset",$.proxy((function(t){this.board.reset({background:!0}),t.preventDefault()}),this))},updateBack:function(t){this.board.history.canUndo()?t.removeAttr("disabled"):t.attr("disabled","disabled")},updateForward:function(t){this.board.history.canRedo()?t.removeAttr("disabled"):t.attr("disabled","disabled")}}),DrawingBoard.Control.Size=DrawingBoard.Control.extend({name:"size",defaults:{type:"auto",dropdownValues:[1,3,6,10,20,30,40,50],min:1,max:50},types:["dropdown","range"],initialize:function(){"auto"==this.opts.type&&(this.opts.type=this._iHasRangeInput()?"range":"dropdown");var t=$.inArray(this.opts.type,this.types)>-1&&this["_"+this.opts.type+"Template"]();if(!t)return!1;this.val=this.board.opts.size,this.$el.append($(t)),this.$el.attr("data-drawing-board-type",this.opts.type),this.updateView();var e=this;"range"==this.opts.type&&this.$el.on("change",".drawing-board-control-size-range-input",(function(t){e.val=$(this).val(),e.updateView(),e.board.ev.trigger("size:changed",e.val),t.preventDefault()})),"dropdown"==this.opts.type&&(this.$el.on("click",".drawing-board-control-size-dropdown-current",$.proxy((function(t){this.$el.find(".drawing-board-control-size-dropdown").toggleClass("drawing-board-utils-hidden")}),this)),this.$el.on("click","[data-size]",(function(t){e.val=parseInt($(this).attr("data-size"),0),e.updateView(),e.board.ev.trigger("size:changed",e.val),t.preventDefault()})))},_rangeTemplate:function(){return DrawingBoard.Utils.tpl('<div class="drawing-board-control-inner" title="{{size}}"><input type="range" min="{{min}}" max="{{max}}" value="{{size}}" step="1" class="drawing-board-control-size-range-input"><span class="drawing-board-control-size-range-current"></span></div>',{min:this.opts.min,max:this.opts.max,size:this.board.opts.size})},_dropdownTemplate:function(){var t='<div class="drawing-board-control-inner" title="{{size}}"><div class="drawing-board-control-size-dropdown-current"><span></span></div><ul class="drawing-board-control-size-dropdown">';return $.each(this.opts.dropdownValues,(function(e,o){t+=DrawingBoard.Utils.tpl('<li data-size="{{size}}"><span style="width: {{size}}px; height: {{size}}px; border-radius: {{size}}px;"></span></li>',{size:o})})),t+="</ul></div>"},onBoardReset:function(t){this.updateView()},updateView:function(){var t=this.val;if(this.board.ctx.lineWidth=t,this.$el.find(".drawing-board-control-size-range-current, .drawing-board-control-size-dropdown-current span").css({width:t+"px",height:t+"px",borderRadius:t+"px",marginLeft:-1*t/2+"px",marginTop:-1*t/2+"px"}),this.$el.find(".drawing-board-control-inner").attr("title",t),"dropdown"==this.opts.type){var e=null;$.each(this.opts.dropdownValues,(function(o,i){(null===e||Math.abs(i-t)<Math.abs(e-t))&&(e=i)})),this.$el.find(".drawing-board-control-size-dropdown").addClass("drawing-board-utils-hidden")}},_iHasRangeInput:function(){var t,e=document.createElement("input"),o=document.documentElement,i="range";return e.setAttribute("type",i),t="text"!==e.type,e.value=":)",e.style.cssText="position:absolute;visibility:hidden;",/^range$/.test(i)&&void 0!==e.style.WebkitAppearance&&(o.appendChild(e),defaultView=document.defaultView,t=defaultView.getComputedStyle&&"textfield"!==defaultView.getComputedStyle(e,null).WebkitAppearance&&0!==e.offsetHeight,o.removeChild(e)),!!t}}),DrawingBoard.Control.Download=DrawingBoard.Control.extend({name:"download",initialize:function(){this.$el.append('<button class="drawing-board-control-download-button"></button>'),this.$el.on("click",".drawing-board-control-download-button",$.proxy((function(t){this.board.downloadImg(),t.preventDefault()}),this))}});