"use strict";var globalMirror=false;(function(e,r,a){var t=false;var i=false;var s=false;window.cancelcast=false;window.local_stream=null;var n=.8;var o=.4;var c=n;var l=document.createElement("video");var d=document.createElement("canvas");var h=d.getContext("2d");var m;var u;var p=require("ts-ebml");var g=new p.Decoder;window.streamFormat="mjpeg";var v=[];var f=[];var y=0;var w=0;var b=false;var M=48e3;if(p&&g&&MediaRecorder.isTypeSupported("video/webm;codecs=h264,pcm")){console.log("[captureScreen]Using h264");streamFormat="h264"}class k{constructor(){if(m){return m}else{m=this;this.pause=false;this.DisplayW=0;this.DisplayH=0;this.IsCasting=false;this.callbacks={OnFinish:null};r.callbacks.onImageSent=this.ImageSent.bind(this);chrome.system.display.getInfo(function(e){for(var r=0;r<e.length;r++){if(e[r].isPrimary){this.DisplayW=e[r].bounds.width;this.DisplayH=e[r].bounds.height;break}}}.bind(this))}}ImageSent(e){if(e.resultCode===0&&this.IsCasting){if(streamFormat=="mjpeg"){this.sendLiveImage()}}else if(e.resultCode<0){}}paused(){u.pause()}continued(){u.resume()}onAccessApproved(e){if(streamFormat==="mjpeg"){k.prototype.gotStream=C}else{k.prototype.gotStream=A}if(!e){r.disconnect();var a="ScreenCap\r\nfinish\r\n\r\n";var t=currentAddress;window.sendTCPMsg(a,t,8121);console.log("Desktop Capture access rejected.");return}navigator.webkitGetUserMedia({audio:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e,minFrameRate:1,maxFrameRate:15,minWidth:this.DisplayW>1920?1920:this.DisplayW,maxWidth:this.DisplayW>1920?1920:this.DisplayW,minHeight:this.DisplayH>1080?1080:this.DisplayH,maxHeight:this.DisplayH>1080?1080:this.DisplayH}}},this.gotStream.bind(this),this.getUserMediaError.bind(this))}getUserMediaError(e){chrome.runtime.sendMessage({uiAction:"error",error:"Can not get user media:"+e});console.error("Unable to getUserMedia,"+JSON.stringify(e))}startLive(e){this.callbacks.OnFinish=e;window.sefef=chrome.desktopCapture.chooseDesktopMedia(["screen","audio"],this.onAccessApproved.bind(this))}cancelChooseDesktopMedia(){chrome.desktopCapture.cancelChooseDesktopMedia(sefef);r.disconnect()}downloadVidFunc(){var e=new Blob(v,{type:"video/webm"});var r=URL.createObjectURL(e);var a=document.createElement("a");document.body.appendChild(a);a.style="display: none";a.href=r;a.download="test.webm";a.click();window.URL.revokeObjectURL(r)}downloadAudFunc(){var e=new Blob(f,{type:"video/webm"});var r=URL.createObjectURL(e);var a=document.createElement("a");document.body.appendChild(a);a.style="display: none";a.href=r;a.download="test.pcm";a.click();window.URL.revokeObjectURL(r)}sendLiveImage(){if(streamFormat!=="mjpeg"){return}else{h.drawImage(l,0,0,this.DisplayW,this.DisplayH);try{var e=atob(d.toDataURL("image/jpeg",c).replace("data:image/jpeg;base64,",""));if(r.isConnected&&e&&e.length>0){r.sendStreamPic(a.str2ab(e))}else{return}}catch(e){console.warn("Send stream err! "+e);r.sendStreamPic(STREES_FORMAT.OUT_PIX_FMT_JPEG,this.DisplayW,this.DisplayH,10,a.str2ab("1234567890"));return}}}prePauseLive(){chrome.runtime.sendMessage({uiAction:"minimizeWindow"})}pauseLive(){setTimeout(function(){this.pause=true}.bind(this),1e3)}resumeLive(){this.pause=false}setQuality(e){if(U(e)){if(u&&u.state!=="inactive"){u.stop();URL.revokeObjectURL(l.src);u=k.prototype.createMediaRecorder(local_stream,e,this);var r=50;u.start(r)}}c=e==="high"?n:o;chrome.storage.local.set({mirrorQuality:e})}createMediaRecorder(a,n,o){var c="video/webm;codecs=h264,pcm";var d;var h={mimeType:c,video:{maxWidth:1280,maxHeight:720}};b=false;M=48e3;w=0;h.audioBitsPerSecond=64e3;h.BitsPerSecond=3e6;var m=new MediaRecorder(a,h);m.addEventListener("error",(e=>{console.log("error recording stream")}));m.ondataavailable=function(e){if(e.data.size>0&&!o.pause){l.src=URL.createObjectURL(e.data);fetch(l.src).then((e=>e.arrayBuffer())).then((function(e){var a=g.decode(e);for(var t in a){if(a[t]["name"]==="Audio")b=true;if(a[t]["name"]==="SamplingFrequency"){var i=new Uint8Array(4);i[0]=a[t]["data"][3];i[1]=a[t]["data"][2];i[2]=a[t]["data"][1];i[3]=a[t]["data"][0];var s=R(i,Float32Array);M=s[0]}if(a[t]["name"]==="SimpleBlock"){if(b&&a[t]["data"][0]===129){let e=a[t]["data"].subarray(4,a[t]["data"].length);r.sendAudioData(D(e,M,22050))}else{let e=a[t]["data"].subarray(4,a[t]["data"].length);r.sendVideoStreamh264(e)}}}})).catch((e=>{console.log("[captureScreen]Decode err! "+e)}))}};m.onerror=function(){console.log("MediaRecorder 记录出错了")};m.onstart=function(){console.log("[captureScreen]Start recording")};m.onstop=function(){if(t||i){e["Capture"].downloadVidFunc()}if(s){e["Capture"].downloadAudFunc()}};return m}}function C(a){cancelcast=true;console.log("livestream : mjpeg");chrome.runtime.sendMessage({action:"mirrorAprroved"});if(e.Media.IsPlaying){e.Media.End(false)}local_stream=a;this.IsCasting=true;globalMirror=true;l.autoplay=true;l.src=URL.createObjectURL(a);l.volume=0;a.getTracks()[0].onended=function(){if(this.IsCasting){this.IsCasting=false;globalMirror=false;cancelcast=false;chrome.runtime.sendMessage({uiAction:"endMirror"});chrome.runtime.sendMessage({uiAction:"exceDisconnect"});chrome.runtime.sendMessage({uiAction:"timeOutProcess"});if(this.callbacks.OnFinish)this.callbacks.OnFinish();if(r.host){var e="ScreenCap\r\nfinish\r\n\r\n";var a=r.host;window.sendTCPMsg(e,a,8121)}r.disconnect()}}.bind(this);chrome.runtime.sendMessage({uiAction:"allowMirror"});d.width=this.DisplayW;d.height=this.DisplayH;this.sendLiveImage()}function A(a){cancelcast=true;console.log("livestream : h264stream");if(e.Media.IsPlaying){e.Media.End(false)}chrome.storage.local.get("mirrorQuality",function(e){local_stream=a;var t=50;u=k.prototype.createMediaRecorder(a,e.mirrorQuality,this);var i;this.IsCasting=true;globalMirror=true;a.getTracks()[0].onended=function(){console.log("Stream ended");if(this.IsCasting){if(u&&u.state!=="inactive"){u.stop();URL.revokeObjectURL(l.src)}local_stream=null;this.IsCasting=false;globalMirror=false;cancelcast=false;if(i){clearInterval(i)}chrome.runtime.sendMessage({uiAction:"endMirror"});chrome.runtime.sendMessage({uiAction:"exceDisconnect"});chrome.runtime.sendMessage({uiAction:"timeOutProcess"});console.log("Desktop sharing stopped...");if(this.callbacks.OnFinish)this.callbacks.OnFinish();if(r.host){var e="ScreenCap\r\nfinish\r\n\r\n";var a=r.host;window.sendTCPMsg(e,a,8121)}r.disconnect()}}.bind(this);chrome.runtime.sendMessage({uiAction:"allowMirror"});chrome.runtime.sendMessage({uiAction:"createPost"});chrome.runtime.sendMessage({uiAction:"screenPower"});u.start(67)}.bind(this))}function L(e){this.callbacks.OnFinish=e;if(local_stream){var r=local_stream.getTracks();r.forEach((function(e){e.stop();try{e.onended()}catch(e){console.log("Track.onended() error")}}))}local_stream=null}function S(e){this.callbacks.OnFinish=e;if(u&&u.state!=="inactive"){u.stop();URL.revokeObjectURL(l.src)}if(local_stream){var r=local_stream.getTracks();r.forEach((function(e){e.stop();try{e.onended()}catch(e){console.log("Track.onended() error")}}));chrome.runtime.sendMessage({uiAction:"endMirror"})}local_stream=null;this.pause=false}k.prototype.stopLive=S;if(streamFormat==="mjpeg"){k.prototype.stopLive=L}function R(e,r){var a=new ArrayBuffer(e.byteLength);var t=new e.constructor(a).set(e);return new r(a)}function D(e,r,a){var t=R(e,Float32Array);var i=r/a;var s=t.length/i;var n=true;var o=0,c=0;var l;if(n){var d=t.length/2;l=new Float32Array(d);var h=0;while(h<d){l[h]=t[h*2];h++}s=s/2}else{l=t}var m=new Int16Array(s);while(o<s){var u=l[c|0];var p=l[(c|0)+1];var g=u+(p-u)*(c-(c|0));m[o++]=g*32767|0;c+=i}return m}function U(e){var r="";if(c===.8){r="high"}else{r="low"}return e!==r}e["Capture"]=new k})(window["ESHARECMCLIENTBG"]["background"],window["ESHARECMCLIENTBG"]["background"]["EMirroring"],window["ESHARECMCLIENTBG"]["Util"]);