"use strict";var backaddress;(function(e,n,t,o,i,r,s,a,c,u,d,l){var f;var m="000000000000";var g=false;var w=false;var p=false;var v={};let C="";let h=false;let S=false;let M=null;window.deviceNameBE="chrome";chrome.app.runtime.onLaunched.addListener((async function(){chrome.app.window.create("index.html",{id:"ESClientMain",frame:"none",innerBounds:{width:600,height:450,minWidth:600,minHeight:450}},(function(e){e.contentWindow["ESHARECMCLIENT"]={};e.contentWindow["ESHARECMCLIENT"]["Util"]=l;chrome.app.window.get("ESClientMain").onClosed.addListener((function(){v["appClose"]()}))}));{p=true}await c.init((function(e){console.log("SSDP inited result:"+e)}))}));chrome.runtime.onMessage.addListener((function(e,n,t){if(!e.action||!v[e.action])return;v[e.action](e)}));v["ReceiverError"]=function(e){t.stopLive()};v["discovery"]=function(){chrome.runtime.getPlatformInfo((function(e){ESClientPlatformOS=e.os;_()}))};v["saveDeviceName"]=function(e){chrome.storage.sync.set({chrome:e.data},(function(){window.deviceNameBE=e.data;chrome.runtime.sendMessage({uiAction:"onDeviceNameSaved",data:e.data})}))};v["readDeviceName"]=function(e){chrome.storage.sync.get("chrome",(function(e){if(e["chrome"]){console.log("New device name:",e["chrome"]);deviceNameBE=e["chrome"];chrome.runtime.sendMessage({uiAction:"onDeviceNameRead",data:deviceNameBE})}else{chrome.runtime.sendMessage({uiAction:"requestDeviceName"})}}))};v["connectpassword"]=function(e){var n="CHECKPASSWORD\r\n"+e.pwdd+"\r\n\r\n";var t=e.address;c.checkCode(t,n)};v["connectpasswordthree"]=function(e){var n=e.pwddwd;var t=e.address;c.checkCode(t,n)};v["pasuedscreen"]=function(e){t.paused()};v["continuescreen"]=function(e){t.continued()};v["nofeature"]=function(e){var n=e.windowString,t=e.address;window.windowfeature(t,n)};v["sendHeartBeatToMirror"]=function(e){chrome.runtime.sendMessage({tvMirrorAction:"sendMirror",data:e.data})};v["stopReturn"]=function(e){chrome.runtime.sendMessage({tvMirrorAction:"onStopTvMirror"});var n=e.stop,t=e.address;window.windowfeature(t,n);o.disconnect()};v["windowfeature"]=function(e){console.log("msg windowfeature");var n=e.windowString,t=e.address;window.windowfeature(t,n)};v["HeartBeat"]=function(e){console.log("using windowfeature");var n=e.windowString,t=e.address;window.windowfeature(t,n)};v["sendTCPMsg"]=function(e){if(streamFormat==="mjpeg"){var n=e.msg;var t=e.address;window.sendTCPMsg(n,t,8121)}else{return}};v["clientSayhello"]=function(e){c.sayhelloclient(e.address,e.getServerInfo)};v["requestpermission"]=function(e){var n=e.powerhostname;var t=e.powerstring;var o=t.indexOf("%");var i=t.substring(0,o);var r=t.substring(o+2);var s=i+n+r;var a=e.powerpassword;c.powerfun(s,a)};v["startGetImg"]=function(e){S=true;E({hubIp:C})};v["startTvMirror"]=function(e){if(e.rotation==0){chrome.app.window.create("tvMirror.html",{id:"tvMirrorsWinodw",innerBounds:{width:960,height:580,minWidth:960,minHeight:580},frame:"none"},(function(e){chrome.app.window.get("ESClientMain").onClosed.addListener((function(){chrome.runtime.sendMessage({uiAction:"tvwindowclose"})}));chrome.runtime.sendMessage({uiAction:"tvwindowcreate"})}))}else if(e.rotation==270||e.rotation==90){chrome.app.window.create("tvMirror.html",{id:"tvMirrorsWinodw",innerBounds:{width:580,height:960,minWidth:580,minHeight:960},frame:"none"},(function(e){chrome.app.window.get("ESClientMain").onClosed.addListener((function(){chrome.runtime.sendMessage({uiAction:"tvwindowclose"})}));chrome.runtime.sendMessage({uiAction:"tvwindowcreate"})}))}else{}C=e.hubIp;h=true;M=new a(e.hubIp,8121);M.init((function(){if(!M.isConnected){console.log("TCP create failed");M.disconnect((function(){console.log("TCP disconnected")}));return}console.log("TCP created:"+C);M.addResponseListener((function(e){console.log("this is socketid8"+e.socketId);console.log(e)}))}))};v["stopTvMirror"]=function(e){console.log("stopping");h?chrome.runtime.sendMessage({tvMirrorAction:"onStopTvMirror"}):console.log("no tv mirroring, byebye")};v["getImg"]=function(e){if(S){y({hubIp:C})}else{E({hubIp:C});console.log("get first data");S=true}};v["mouseEvent"]=function(e){let n="MIRRORTOUCHEVENT\r\n"+e.cmd+"\r\n"+"[={"+e.x+","+e.y+"}]"+"\r\n\r\n";M.send(l.str2ab(n),(()=>{if(e.rightClick){console.log("right");setTimeout((()=>{v["mouseRightClick"]({x:e.x,y:e.y})}),100)}}))};v["KeyCodeEvent"]=function(e){let n="KEYEVENT\r\n"+e.keyCode+"\r\n\r\n";var t=l.str2ab(n);console.log("测试键盘输入"+l.str2ab(n));M.send(l.str2ab(n),(()=>{}))};v["mouseRightClick"]=function(e){let n="TOUCHLOGNPRESS\r\n[={"+e.x+","+e.y+"}]\r\n\r\n";M.send(l.str2ab(n),(()=>{}))};v["keyEvent"]=function(e){let n="KEYEVENT\r\n"+e.cmd+"\r\n\r\n";console.log("对比一下"+l.str2ab(n));M.send(l.str2ab(n))};v["drawStart"]=function(e){let n="DRAW\r\n"+e.isNote+"\r\n\r\n";M.send(l.str2ab(n))};v["drawPen"]=function(e){let n="PEN_STYLE\r\n"+e.color+"\r\n"+e.size+"\r\n\r\n";M.send(l.str2ab(n))};v["drawMsg"]=function(e){let n="PAINT_MSG\r\n"+e.actionStatus+" "+e.x+" "+e.y+"\r\n\r\n";M.send(l.str2ab(n));console.log("判断画图"+e.actionStatus+"x坐标"+e.x+"y坐标"+e.y+"状态"+e.actionStatus)};v["clearDraw"]=function(e){let n="CLEAR\r\n"+e.isbooleam+"\r\n\r\n";M.send(l.str2ab(n))};function y(e){i.keepGettingJpeg(e.hubIp,26,function(e){chrome.runtime.sendMessage({tvMirrorAction:"onStartTvMirror",jpgStr:e.jpgStr,id:e.id})}.bind(this))}function E(e){i.getImageJpeg(e.hubIp,26,function(e){chrome.runtime.sendMessage({tvMirrorAction:"onStartTvMirror",jpgStr:e.jpgStr,id:e.id})}.bind(this))}v["connectToDevice"]=function(e){s.receive=undefined;n.connect(e.ip,(function(){if(!e.ip){console.log("Set device failed");return}m="";var t=!p?"savePrefer":"connectedToProjector";if(!n.getCurrDevice()){chrome.runtime.sendMessage({uiAction:"ipaddressError"})}chrome.runtime.sendMessage({uiAction:t,device:n.getCurrDevice()?n.getCurrDevice():e.ip,MAC:m})}))};v["connectIP"]=function(e){f=e.ip;_(f)};v["currentaddress"]=function(e){console.error("[BACKGROUND]Saving address:"+e.currentAddress);window.currentAddress=e.currentaddress};v["setUserID"]=function(e){ESClientUserUniqueID=e.id};v["setCountryCode"]=function(e){ESClientCountryCode=e.code};v["answerGuest"]=function(e){n.answerGuest(e.isAllow)};v["cancelRequest"]=function(e){n.cancelRequest()};v["appClose"]=function(e){A();c.shutdown();s.close();setTimeout((function(){chrome.sockets.udp.getSockets((e=>{e.forEach((async e=>{if(e)await chrome.sockets.udp.close(e.socketId,(function(){}))}))}));chrome.sockets.tcp.getSockets((e=>{e.forEach((async e=>{if(e)if(e.connected)await chrome.sockets.tcp.close(e.socketId,(function(){}))}))}))}),1e3)};v["stopDisplay"]=function(e){A()};v["startMirror"]=function(e){v["startMirrorImp"](e.address)};v["startMirrorImp"]=function(e){if(r.IsPlaying){r.End(false);return}T(e,(function(e,n){t.startLive(D)}))};v["mirrorAprroved"]=function(e){r.End(false)};v["stopMirror"]=async function(e){await t.stopLive(D);await o.Reset();chrome.runtime.sendMessage({uiAction:"endMirror"})};v["setQuality"]=function(e){t.setQuality(e.quality)};v["splitScreen"]=function(e){var t=n.getCurrDevice();if(n.Role()==="host"&&t.passcode&&t.passcode!==""){chrome.runtime.sendMessage({uiAction:"onStartMirror",device:JSON.stringify(n.getCurrDevice()),count:e.count,pos:e.pos,callback:"splitScreenImp"})}else{v["splitScreenImp"]()}};v["splitScreenImp"]=function(e){if(!o.isConnected)T(n.getCurrDevice().Address,(function(n,t){o.requestStream(e.count,e.pos)}));else o.requestStream(e.count,e.pos)};v["SetNoDisturb"]=function(e){n.SetNoDisturb(e.value)};v["SetAutoAllow"]=function(e){n.SetAutoAllow(e.value)};v["SetUsePrefer"]=function(e){p=e.value};v["happy"]=function(e){o.SendChrome()};v["mediaStreaming"]=function(e){var t=n.getCurrDevice();if(n.Role()==="host"&&t.passcode&&t.passcode!==""){chrome.runtime.sendMessage({uiAction:"onStartMirror",device:JSON.stringify(n.getCurrDevice()),media:e.media,callback:"mediaStreamingImp"})}else{v["mediaStreamingImp"](e)}};v["mediaStreamingImp"]=function(e){if(r.IsPlaying&&!r.Started)return;if(r.IsSwitchPage)chrome.runtime.sendMessage({uiAction:"goMediaStreaming"});if(t.IsCasting){w=true;console.log("错误可能3");t.stopLive((function(){T(n.getCurrDevice().Address,(function(n,t){r.Start(e.media)}))}))}else{if(r.IsPlaying)r.End(false,(function(){r.Start(e.media)}));else T(n.getCurrDevice().Address,(function(n,t){r.Start(e.media)}))}};v["mediaResume"]=function(e){if(r.IsPlaying)r.Resume();else{if(t.IsCasting){w=true;console.log("错误可能4");t.stopLive((function(){T(n.getCurrDevice().Address,(function(e,n){r.Start()}))}))}else{T(n.getCurrDevice().Address,(function(e,n){r.Start()}))}}};v["mediaPause"]=function(e){r.Pause()};v["mediaVolUp"]=function(e){r.VolUp()};v["mediaVolDown"]=function(e){r.VolDown()};v["mediaStop"]=function(e){r.End(false)};v["mediaPlaynext"]=function(e){if(r.HasNext())r.End(false,r.Playnext())};v["mediaPlayprev"]=function(e){if(r.HasPrev())r.End(false,r.Playprev())};v["mediaSeekTo"]=function(e){r.Seek(e.time)};v["playlist"]=function(e){console.log("Get playlist from extractor");if(e.media.playlist)r.GetPlaylist(e.media);else console.log("[Callback Playlist JSON format incorrect]")};v["cancelChooseDesktopMedia"]=function(e){t.cancelChooseDesktopMedia()};v["askSplitAndPosition"]=function(e){if(e.reply){var n=e.reply;chrome.runtime.sendMessage({actionReply:n,streamPos:o.streamPos,streamCnt:o.streamCnt})}};v["askIsMediaPlaying"]=function(e){if(e.reply){var n=e.reply;chrome.runtime.sendMessage({actionReply:n,isPlaying:r.IsPlaying})}};v["getIpConnectName"]=function(e){c.checkCode(e.address,e.getServerInfo)};v["startCastSocketChecker"]=function(e){console.log("[Background]Start CastSocket checker");c.startCastSocketChecker()};v["CreateModConn"]=function(e){let n={reportClientInfo:e.reportClientInfo,clientName:e.clientName,clientType:e.clientType,isTouchable:e.isTouchable,versionName:e.versionName,versionCode:e.versionCode};c.CreateModConn(e.ip,JSON.stringify(n))};v["DeviceInfoChange"]=function(e){let n={reportClientInfo:e.reportClientInfo,clientName:e.clientName,clientType:e.clientType,isTouchable:e.isTouchable,versionName:e.versionName,versionCode:e.versionCode};c.SendToModConn(JSON.stringify(n))};v["disconnectClient"]=function(e){c.disconnectClient(e.disconnectClient)};v["mirrorBefore"]=function(e){c.SendToModConn(e.RequestContent)};v["disconnectWithReceiver"]=function(e){c.disconnectWithReceiver()};v["cancelCast"]=function(e){c.SendToModConn(e.cancelCastKey)};v["askInvitation"]=function(e){c.SendToModConn(e.askInvitationKey)};async function T(e,i){if(g)return;g=true;if(o.isConnected){i(o.getCount,o.getPosition);g=false}else{if(n.getCurrDevice()&&n.getCurrDevice().UseJSON){n.requestStream((async function(n){if(n==="allow"){if(streamFormat==="mjpeg"){console.warn("here1!");o.connect(e,i)}else{await o.connectbyh264(e,i);await o.createAudioSocket(e);console.warn("here2!");let n={last:(new Date).getTime(),count:0};o.Set51030ErrListener((async e=>{console.warn("[background]Received err from emirroring! "+e);if((new Date).getTime()-n.last<5e3&&n.count>10){await t.stopLive(D);await chrome.runtime.sendMessage({uiAction:"endMirror"})}else if((new Date).getTime()-n.last<5e3){n.last=(new Date).getTime();n.count++}else{n.count=0}}));o.Set51040ErrListener((async e=>{console.warn("[background]Received err from emirroring! "+e);if((new Date).getTime()-n.last<5e3&&n.count>10){await t.stopLive(D);await chrome.runtime.sendMessage({uiAction:"endMirror"})}else if((new Date).getTime()-n.last<5e3){n.last=(new Date).getTime();n.count++}else{n.count=0}}))}}else if(n==="wait"){chrome.runtime.sendMessage({uiAction:"waitHost",isOpen:true});o.prepare(e,i)}else{chrome.runtime.sendMessage({uiAction:"deniedRequest",msg:chrome.i18n.getMessage("REQUEST_RESULT_DENY")});o.resetPrepare()}g=false}))}else{if(streamFormat==="mjpeg"){console.warn("here3!");o.connect(e,i)}else{console.warn("here4!");let n={last:(new Date).getTime(),count:0};await o.connectbyh264(e,i);await o.createAudioSocket(e);o.Set51030ErrListener((async e=>{console.warn("[background]Received err from emirroring! "+e);if((new Date).getTime()-n.last<5e3&&n.count>10){await t.stopLive(D);await chrome.runtime.sendMessage({uiAction:"endMirror"})}else if((new Date).getTime()-n.last<5e3){n.last=(new Date).getTime();n.count++}else{n.count=0}}));o.Set51040ErrListener((async e=>{console.warn("[background]Received err from emirroring! "+e);if((new Date).getTime()-n.last<5e3&&n.count>10){await t.stopLive(D);await chrome.runtime.sendMessage({uiAction:"endMirror"})}else if((new Date).getTime()-n.last<5e3){n.last=(new Date).getTime();n.count++}else{n.count=0}}))}g=false}}}function D(){if(!r.IsPlaying&&!t.IsCasting)setTimeout((function(){o.SendChrome()}),500)}function A(){r.End(false);n.disconnect();o.disconnect();u.stopServer()}function I(e,n,t){try{var o=new XMLHttpRequest;o.open("GET",e+n,true);o.onreadystatechange=function(){if(o.readyState==4){t(o.responseText)}};o.send(null)}catch(e){console.log(e)}}function k(e){var t="eshare";if(n.getCurrDevice().Family.toLowerCase()==="eshare"&&n.getCurrDevice().Type.toLowerCase()==="music")t="esharemusic";else if(n.getCurrDevice().Family.toLowerCase()==="eshare"&&n.getCurrDevice().Type.toLowerCase()==="car")t="esharecar";else if(n.getCurrDevice().Family.toLowerCase()==="eshare"&&n.getCurrDevice().Type.toLowerCase()==="lite")t="esharelite";else if(n.getCurrDevice().Family.toLowerCase()==="eshare"&&n.getCurrDevice().Type.toLowerCase()==="wire")t="esharewire";if(n.getCurrDevice().Family.toLowerCase()==="esharepro")t="esharepro";var o="https://url.com"+n.getCurrDevice().ID+"&type="+t;R(o,(function(e){B(e,JSON.stringify(L()))}));I(n.getCurrDevice().Webroot,"dongleInfo.json",(function(e){var n="https://url.com"+m+"&type="+t;R(n,(function(n){B(n,e)}))}))}function N(e){var t="https://url.com"+n.getCurrDevice().Type;R(t,(function(n){B(n,JSON.stringify(e))}))}function b(e){chrome.storage.local.get("urlscheme",(function(n){e(n.urlscheme)}))}function R(e,n){b((function(t){var o=7;var i=[e.slice(0,o),t,e.slice(o)].join("");n(i)}))}function L(){return{schema_version:4,mac_address:m,os_type:"cros",os_version:ESClientPlatformOS,manufacturer:"ChromeApp",model:"ChromeApp",app_version:chrome.runtime.getManifest().version.toString(),resolution:{width:t.DisplayW,height:t.DisplayH},language:navigator.language,country:ESClientCountryCode}}var P=navigator.connection||navigator.mozConnection||navigator.mozConnection||navigator.webkitConnection;navigator.webkitConnection;P.addEventListener("change",(()=>{}));function H(e){return{schema_version:3,dongle_mac_address:n.getCurrDevice().ID,firmware_version:n.getCurrDevice().Version,app_mac_address:m,app_os_type:"cros",app_version:chrome.runtime.getManifest().version.toString(),user_agent:MYuserAgent,web_video:[{web_page_url:e.page,video_url:e.src,result:0,duration:e.duration,title:e.title,timestamp:e.timestamp,category:"web"}]}}function B(e,n){try{var t=new XMLHttpRequest;t.open("POST",e,true);t.setRequestHeader("Content-type","application/json; charset=utf-8");t.onreadystatechange=function(){if(t.readyState==4){console.log("DongleInfo Pushed:"+t.responseText)}};t.send(n)}catch(e){console.log(e)}}async function _(e){if(e){console.warn("here!!!");c.discoverTCP(e,G)}else{c.services=[];await c.sendEShareDiscover();await c.sendBoxlightDiscover();window.setTimeout((async function(){c.getServices((e=>{if(e.length<=0){console.warn("Services not found");chrome.runtime.sendMessage({uiAction:"onServicesNotFound"})}}))}),3e3)}}function G(e){let n=e.data.split(":");let t=n[0];let o=n[4].split("=")[1];chrome.runtime.sendMessage({uiAction:"found",data:{ip:e.remoteAddress,features:o,name:t}})}})(window["ESHARECMCLIENTBG"]["background"],window["ESHARECMCLIENTBG"]["background"]["Remote"],window["ESHARECMCLIENTBG"]["background"]["Capture"],window["ESHARECMCLIENTBG"]["background"]["EMirroring"],window["ESHARECMCLIENTBG"]["background"]["TVMirror"],window["ESHARECMCLIENTBG"]["background"]["Media"],window["ESHARECMCLIENTBG"]["NetWork"]["UdpSocket"],window["ESHARECMCLIENTBG"]["NetWork"]["TcpSocket"],window["ESHARECMCLIENTBG"]["NetWork"]["SSDP"],window["ESHARECMCLIENTBG"]["NetWork"]["HttpServer"],window["ESHARECMCLIENTBG"]["JpgPackets"],window["ESHARECMCLIENTBG"]["Util"]);