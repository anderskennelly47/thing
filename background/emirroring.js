(function(e,t,n,i){var r;var a;var s;var o;var c;var l;var d=0;var h=0;var u=0;var f=0;window.localIp=null;var S=0;var T=true;var v=256;var E=257;var C=[];var g={iceServers:[{urls:"stun:stun.services.mozilla.com"}]};var D=new RTCPeerConnection(g);D.createDataChannel("");var U={format:STREES_FORMAT.OUT_PIX_FMT_JPEG,width:0,height:0,size:0,data:{}};var m=0;var _=0;var w=[98,112,108,105,115,116,48,48,209,1,2,87,115,116,114,101,97,109,115,161,3,213,4,6,8,10,12,5,7,9,11,13,84,116,121,112,101,16,110,92,67,104,114,111,109,101,83,116,114,101,97,109,9,92,109,97,99,104,105,110,101,95,110,97,109,101,74,67,104,114,111,109,101,66,111,111,107,160,90,109,97,99,104,105,110,101,95,105,112,73,49,50,55,46,48,46,48,46,49,160,95,16,19,109,97,99,104,105,110,101,95,109,97,99,95,97,100,100,114,101,115,115,79,16,17,49,49,58,50,50,58,51,51,58,52,52,58,53,53,58,54,54,160,8,11,19,21,32,37,39,52,53,66,78,89,100,122,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,14,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,143];var P;class M{constructor(){if(P){return P}else{P=this;this.callbacks={connected:null,disconnected:null,mediaStreaming:null,onImageSent:null,requestStream:null,recv51030Error:null,recv51040Error:null,recv25123Error:null};this.waitTarget=undefined;this.waitCallback=undefined;this.isConnected=false;this.streamCnt=0;this.streamPos=0;k();C[MXDU_CMD.MXDU_REQUEST]=this.onPicoRequest.bind(this);C[MXDU_CMD.MXDU_NOTIFICATION]=this.onPicoNotification.bind(this);C[MXDU_CMD.MXDU_AV_STREES_CMD]=this.onPicoAVStream.bind(this)}}Reset(){if(s&&s.isConnected){s.disconnect()}if(a&&a.isConnected){a.disconnect()}if(r&&r.isConnected){r.disconnect()}this.callbacks={connected:null,disconnected:null,mediaStreaming:null,onImageSent:null,requestStream:null,recv51030Error:null,recv51040Error:null,recv25123Error:null};this.waitTarget=undefined;this.waitCallback=undefined;this.isConnected=false;this.streamCnt=0;this.streamPos=0;k();C[MXDU_CMD.MXDU_REQUEST]=this.onPicoRequest.bind(this);C[MXDU_CMD.MXDU_NOTIFICATION]=this.onPicoNotification.bind(this);C[MXDU_CMD.MXDU_AV_STREES_CMD]=this.onPicoAVStream.bind(this)}Set51030ErrListener(e){this.callbacks.recv51030Error=e}Set51040ErrListener(e){this.callbacks.recv51040Error=e}Set25123ErrListener(e){this.callbacks.recv25123Error=e}RTSPSetupOptions(){chrome.system.display.getInfo((function(e){let t=e[0].rotation;var n=i.str2ab("OPTIONS rtsp://"+localIp+" RTSP/1.0\r\nCSeq: "+u+++"\r\nrotation: 0\r\nUser-Agent: EShare (EShare 1.0)\r\nDeviceName: "+deviceNameBE+"Content-Length: 0"+"\r\n\r\n");r.send(n)}))}RTSPSetupVideo(){var e=i.str2ab("SETUP rtsp://"+localIp+" RTSP/1.0\r\nCSeq: "+u+++"\r\nUser-Agent: EShare (EShare 1.0)\r\nDeviceName: "+deviceNameBE+" \r\nContent-Length: "+w.length+"\r\n\r\n");var t=new ArrayBuffer(w.length);var n=new Uint8Array(t);for(var a=0;a<w.length;a++){n[a]=w[a]}r.send(e);r.send(t)}RTSPTearDown(){var e=i.str2ab("TEARDOWN rtsp://"+localIp+" RTSP/1.0\r\nCSeq: "+u+++"\r\nUser-Agent: EShare (EShare 1.0)\r\nContent-Length: "+w.length+"\r\n\r\n");var t=new ArrayBuffer(w.length);var n=new Uint8Array(t);for(var a=0;a<w.length;a++){n[a]=w[a]}r.send(e);r.send(t)}connect(e,n){if(r)this.disconnect();this.host=e;r=new t(e,56789);r.callbacks.sentImage=this.onImageSent.bind(this);r.init(function(){r.addResponseListener(this.recvEMirroring.bind(this));this.callbacks.connected=n;this.requestStream(0,0,(function(e,t,n,i,r){m=i;_=n}))}.bind(this))}connectbyh264(e,n){if(r)this.disconnect();this.host=e;r=new t(e,51040);let i=false;let a=this;r.init(function(){r.addResponseListener((t=>{if(i)return;i=true;r.setErrorListener(a.callbacks.recv51040Error);T=true;a.callbacks.connected=n;a.createVideoSocket(e);a.startHeartBeat()}));this.RTSPSetupVideo()}.bind(this))}createVideoSocket(e){if(a){a.disconnect((function(){console.log("51030 disconect")}))}a=new t(e,51030);a.callbacks.sentImage=this.onImageSent.bind(this);a.init(function(){a.addResponseListener(this.recvEMirroring.bind(this));a.setErrorListener(this.callbacks.recv51030Error);this.requestStream(0,0,(function(e,t,n,i,r){m=i;_=n}))}.bind(this))}createAudioSocket(e){if(L){if(s){s.disconnect((function(e){}))}s=n;o=e;s.init(e,25123,function(){}.bind(this))}else{if(s){s.disconnect((function(){console.log("25123 disconect")}))}s=new t(e,25123);s.callbacks.sentImage=this.onImageSent.bind(this);s.init(function(){console.log("[eMirroring]AudioSocket init success")}.bind(this));s.setErrorListener(this.callbacks.recv25123Error)}}sendAudioData(e){if(L){s.send(e,o,25123,(function(e){}))}else{s.send(e)}}sendh264PacketData(e,t){var n=new ArrayBuffer(128);var i=new DataView(n);var r=new Date;var s=r.getTime();var o=s/1e3;var c=s%1e3*1/1e3*4294967296;var l=0;i.setUint32(l,e.byteLength,true);l+=4;i.setUint16(l,t,true);l+=2;i.setUint16(l,0,true);l+=2;i.setUint16(l,0,true);l+=2;i.setUint32(l,c,true);l+=4;i.setUint32(l,o,true);l+=4;a.send(n,(function(e){}));a.send(e,(function(e){}))}sendVideoStreamh264(e){if(T){var t=0;var n=0;var i=0;for(var r=0;r<e.length-4;r++){if(e[r]==0&&e[r+1]==0&&e[r+2]==0&&e[r+3]==1){if((e[r+4]&31)==7){t=r;i=1;break}}}if(!i)return;for(var r=t+4;r<e.length-4;r++){if(e[r]==0&&e[r+1]==0&&e[r+2]==0&&e[r+3]==1){if((e[r+4]&31)==8){n=r;break}}}var a=e.slice(t,n+8);this.sendh264PacketData(a,v);console.log("第一次发送");this.sendh264PacketData(e,E);console.log("第二次发送");T=false}else{this.sendh264PacketData(e,E)}}disconnect(){if(r){this.stopHeartBeat();this.RTSPTearDown()}this.isConnected=false;this.streamCnt=0;this.streamPos=0;this.host=0}prepare(e,t){this.waitTarget=e;this.waitCallback=t}resetPrepare(){this.waitTarget=undefined;this.waitCallback=undefined}connectPrepare(){if(streamFormat==="mjpeg"){this.connect(this.waitTarget,this.waitCallback)}else{this.connectbyh264(this.waitTarget,this.waitCallback)}}startHeartBeat(){c=setInterval(function(){this.RTSPSetupOptions()}.bind(this),1e3)}stopHeartBeat(){if(c){clearInterval(c);c=undefined}}send(e,t){if(streamFormat==="h264"){return}else{if(r){if(t==="image")r.sendImage(e);else r.send(e);var n=new Date;l=n.getTime()}}}onImageSent(e){if(this.callbacks.onImageSent)this.callbacks.onImageSent(e)}GetSeq(){return++f}requestStream(e,t,n){this.callbacks.requestStream=n;this.onPicoRequest(1,1,1,1)}sendStreamPic(e){this.send(this.PackPicData(this.GetSeq(),24,MXDU_CMD.MXDU_PIC_FORMAT_CMD,FLAG_TYPE.FLAG_PC_TO_DPF,e),"image")}sendChromePic(e,t,n,i,r,a){e.send(e.PackPicData(e.GetSeq(),24,MXDU_CMD.MXDU_PIC_FORMAT_CMD,FLAG_TYPE.FLAG_PC_TO_DPF,a),"image")}sendAVCmd(e,t,n,i){this.send(this.PackStreamData(this.GetSeq(),24,MXDU_CMD.MXDU_AV_STREES_CMD,FLAG_TYPE.FLAG_PC_TO_DPF,this.PackCDBData(e,t,n,AV_RESULT_TYPE.AV_RESULT_OK),i),"av")}PackHeartbeatData(){return this.PackStreamData(this.GetSeq(),24,MXDU_CMD.MXDU_HEARTBEAT,FLAG_TYPE.FLAG_PC_TO_DPF)}PackCDBData(e,t,n,i){var r=0;var a=new ArrayBuffer(16);var s=new DataView(a);s.setUint32(r,e,true);r+=4;s.setUint32(r,t,true);r+=4;s.setUint32(r,n,true);r+=4;s.setUint32(r,i,true);r+=4;return a}PackStreamData(e,t,n,i,r,a){var s=0;var o=t+(a?a.byteLength:0);var c=new ArrayBuffer(8+o);var l=new DataView(c);l.setUint32(s,e,true);s+=4;l.setUint32(s,o,true);s+=4;l.setUint32(s,n,true);s+=4;l.setUint8(s,i,true);s+=1;l.setUint8(s,r?r.byteLength:0,true);s+=1;l.setUint8(s,0,true);s+=1;l.setUint8(s,0,true);s+=1;if(r){var d=new Uint8Array(r);for(var h=0;h<d.length;h++,s++){l.setUint8(s,d[h])}}if(a){var u=new Uint8Array(a);for(var f=0;f<u.length;f++,s++){l.setUint8(s,u[f])}}return c}PackPicData(e,t,n,i,r){try{var a=0;var s=t+(r?r.byteLength:0);var o=new ArrayBuffer(8+s);var c=new DataView(o);c.setUint8(a,69,true);a+=1;c.setUint8(a,80,true);a+=1;c.setUint8(a,73,true);a+=1;c.setUint8(a,67,true);a+=1;c.setUint32(a,r.byteLength,false);a+=4;d++;var l=new Date;if(h&&l.getTime()-h>1e3){d=0;h=l.getTime()}else if(h==0){h=l.getTime()}if(r){var u=new Uint8Array(r);for(var f=0;f<u.length;f++,a++){c.setUint8(a,u[f])}}return o}catch(e){console.warn("[emirroring]"+e);console.warn("[emirroring]pos:"+a+",pktSize:"+s)}}recvEMirroring(e){var t=0;var n=new DataView(e.data);do{var i=n.getUint32(t,true);var r=n.getUint32(t+4,true);I(e.data.slice(t+8,t+8+r));t=t+8+r}while(t<e.data.byteLength)}onPicoRequest(e,t,n,i){if(this.callbacks.requestStream){this.callbacks.requestStream(this,e,t,n,i)}if(i===STREES_REQUEST_RESULT.REQUEST_RESULT_ALLOW){R(t,n);if(!this.isConnected){if(this.callbacks.connected)this.callbacks.connected(t,n);this.isConnected=true}}else{console.log("MXDU Request Stream DENY");if(!this.callbacks.requestStream)this.disconnect()}this.callbacks.requestStream=null}onPicoNotification(e,t,n,i){if(e===NOTIFY_RESULT.NOTIFICATION_CHANGE_POSITION){R(t,n)}else if(e===NOTIFY_RESULT.NOTIFICATION_STOP_STREAM||e===NOTIFY_RESULT.NOTIFICATION_DISCONNECT){console.log("MXDU NOTIFY STOP/DISCONNECT");this.disconnect()}else if(e===NOTIFY_RESULT.NOTIFICATION_CHANGE_STREAM){console.log("MXDU CHANGE STREAM");this.requestStream(t,n)}}getPosition(){return m}getCount(){return _}onPicoAVStream(e,t,n,i,r){if(this.callbacks.mediaStreaming)this.callbacks.mediaStreaming(e,t,n,i,r)}SendChrome(){if(U.size>0){this.sendStreamPic(U.format,U.width,U.height,U.size,U.data);b(this,500)}}}async function b(e,t){await A(t);e.sendChromePic(e,U.format,U.width,U.height,U.size,U.data);e.sendChromePic(e,U.format,U.width,U.height,U.size,U.data)}function A(e){return new Promise((t=>setTimeout(t,e)))}function I(e){var t=0;var n=new DataView(e);var i=n.getUint32(t,true);t+=4;var r=n.getUint8(t,true);t+=1;t+=3;var a=n.getUint32(t,true);t+=4;var s=n.getUint32(t,true);t+=4;var o=n.getUint32(t,true);t+=4;var c=n.getUint32(t,true);t+=4;if(r===FLAG_TYPE.FLAG_DPF_TO_PC){if(i===MXDU_CMD.MXDU_REQUEST)C[MXDU_CMD.MXDU_REQUEST](a,s,o,c);else if(i===MXDU_CMD.MXDU_NOTIFICATION)C[MXDU_CMD.MXDU_NOTIFICATION](a,s,o,c);else if(i===MXDU_CMD.MXDU_AV_STREES_CMD){var l=e.byteLength>t?e.slice(t):null;C[MXDU_CMD.MXDU_AV_STREES_CMD](a,s,o,c,l)}}}function R(e,t){P.streamCnt=e;P.streamPos=t;chrome.runtime.sendMessage({uiAction:"onNotifyPos",count:e,position:t})}function k(){var e=new XMLHttpRequest;if(chrome.runtime.getManifest().product.toUpperCase()==="ESHAREPRO"){e.open("GET","/Chrome.jpg",true)}else{e.open("GET","/Chrome.jpg",true)}e.responseType="arraybuffer";e.onload=function(t){var n=e.response;if(n){U.format=STREES_FORMAT.OUT_PIX_FMT_JPEG;U.size=n.byteLength;U.data=n;var i=new Blob([e.response],{type:"image/jpg"});var r=new Image;r.onload=function(){U.width=r.width;U.height=r.height};r.src=window.URL.createObjectURL(i)}};e.send(null)}function p(e){let t={};let n=window.RTCPeerConnection||window.webkitRTCPeerConnection;let i=!!window.webkitRTCPeerConnection;if(!n){let e=iframe.contentWindow;n=e.RTCPeerConnection||e.webkitRTCPeerConnection;i=!!e.webkitRTCPeerConnection}function r(n){let i=/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/;let r=i.exec(n);if(!r&&typeof r!=="undefined"&&r!==0)return;if(t[r[1]]===undefined)e(r);t[r]=true}D.onicecandidate=function(e){if(e.candidate){if(!e.candidate.candidate&&typeof e.candidate.candidate!=="undefined"&&e.candidate.candidate!==0){return}else if(e.candidate.candidate){r(e.candidate.candidate)}}};D.createOffer((function(e){D.setLocalDescription(e,(function(){}),(function(){}))}),(function(){}));setTimeout((function(){var e=D.localDescription.sdp.split("\n");e.forEach((function(e){if(e.indexOf("a=candidate:")===0)r(e)}))}),1e3)}p((function(e){if(e===null){return}else if(e[1].match(/^(192\.168\.|192\.8\.|169\.254\.|10\.|172\.(1[6-9]|2\d|3[01]))/)){window.localIp=e[1];console.log("[eMirroring]Local IP:"+localIp)}else{console.error("[eMirroring]Unable to detect valid ip")}}));var L=false;e["EMirroring"]=new M})(window["ESHARECMCLIENTBG"]["background"],window["ESHARECMCLIENTBG"]["NetWork"]["TcpSocket"],window["ESHARECMCLIENTBG"]["NetWork"]["UdpSocket"],window["ESHARECMCLIENTBG"]["Util"]);