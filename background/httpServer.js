(function(e,t,s){var n;var r;class i{constructor(){if(r){return r}else{r=this;this.recvRequest={Wait:false};this.isContentRecv=false}}startServer(e,s,r){if(n){n.disconnect()}n=new t(e,s,{maxConnections:20});n.listen(this.onAcceptCallback.bind(this),r)}stopServer(){if(n){n.disconnect();n=null}}getServerState(){if(n){return{isConnected:n.isConnected(),addr:n.addr,port:n.port}}else{return{isConnected:false}}}onAcceptCallback(e,t){e.addDataReceivedListener(function(t){console.log("[HTTP SERVER]"+t);if(this.recvRequest.Wait){this.recvRequest.CONTENTDATA+=t;this.recvRequest.Wait=this.recvRequest["Content-Length"]&&this.recvRequest["Content-Length"]>this.recvRequest.CONTENTDATA.length}else this.recvRequest=this.parseReq(t.split(/[\n\r]+/));if(!this.recvRequest.Wait)this.processReq(this.recvRequest,e)}.bind(this))}parseReq(e){var t={Wait:false};for(var s=0;s<e.length;s++){var n=e[s];if(n.length>0){var r=n.split(" ");if(s===0){if(r.length<2){console.log("[INVALID HTTP REQUEST FIRST LINE]");return null}t.METHOD=r[0];t.PARAMS=this.getParams(r[1]);t.VERSION="";if(r.length>2){t.VERSION=r[2]}}else{if(r.length>1)t[r[0].split(":")[0]]=r[1];else{t.CONTENTDATA=n}}}}t.Wait=t["Content-Length"]&&t.CONTENTDATA&&t["Content-Length"]>t.CONTENTDATA.length;return t}processReq(e,t){if(e){var s=true;if(e.METHOD==="GET"){if(e.PARAMS.url){try{s=false;var n=null;var r=false;n=new XMLHttpRequest;n.open("GET",e.PARAMS.url,true);n.onreadystatechange=function(){if(n.readyState==4&&!r){r=true;var e=n.responseText;t.sendMessage(this.getResponse(e))}}.bind(this);n.send(null)}catch(t){s=true;console.log("[HTTP_SERVER_ERROR] http.send:"+e.PARAMS.url+" error:"+t)}}else if(e.PARAMS.action){if(/callback/i.test(e.PARAMS.action)){if(e.PARAMS.src&&e.PARAMS.src.length>0){if(e.PARAMS.source_type&&/html/i.test(e.PARAMS.source_type)){chrome.runtime.sendMessage({uiAction:"playVisJS",source:e.PARAMS.src,title:e.PARAMS.title,image:e.PARAMS.image,type:e.PARAMS.source_type})}else{var i={page:e.PARAMS.page,src:e.PARAMS.src,title:e.PARAMS.title,image:e.PARAMS.image,sid:e.PARAMS.sid};chrome.runtime.sendMessage({action:"mediaStreaming",media:i})}}}}}else if(e.METHOD==="POST"){if(e.PARAMS.action){if(/playlist/i.test(e.PARAMS.action)){var l=e.CONTENTDATA.split("=");if(l.length>1){try{var o=JSON.parse(decodeURIComponent(l[1]));console.log(JSON.stringify(o))}catch(e){console.log(e)}}}}}if(s)t.sendMessage(this.getOKResponse());if(e["Connection"]==="close")t.close()}}getParams(e){var t={};var s=null;var n=null;var r=e.indexOf("#");var i=e.indexOf("?");if(r>0&&i>r){i=-1}if(i>=0){n=e.substr(0,i);if(r>=0){s=e.substr(i+1,r-(i+1));fragment=e.substr(r+1)}else{s=e.substr(i+1);fragment=null}}else{s=null;if(r>=0){n=e.substr(0,r);fragment=e.substr(r+1)}else{n=e;fragment=null}}if(s){var l=s.split("&");for(var o=0;o<l.length;o++){var a=l[o].split("=");if(a.length>1){var c=decodeURIComponent(a[0]).toString().toLowerCase();var A=decodeURIComponent(a[1]);t[c]=A}}}return t}getOKResponse(){return this.getResponse("<html><body>ESClient HTTP Server OK</body></html>")}getResponse(e,t){var s="HTTP/1.1 200 OK"+"\n"+"Content-length: "+e.length+"\n"+"Content-type: text/plain; charset=utf-8"+"\n"+"Access-Control-Allow-Origin: *"+"\n"+"Access-Control-Allow-Methods: POST, GET, OPTIONS"+"\n"+"Access-Control-Request-Method: *"+"\n"+"Access-Control-Allow-Headers: *"+"\n";return s+"\n"+e}}e["HttpServer"]=new i})(window["ESHARECMCLIENTBG"]["NetWork"],window["ESHARECMCLIENTBG"]["NetWork"]["TcpServer"],window["ESHARECMCLIENTBG"]["Util"]);