(function(e,t){var s=false;var r=false;var i=0;var o={};var n={};var c="host";function h(){var e={jsonrpc:"2.0",id:++i};return e}function d(e){try{JSON.parse(e)}catch(e){return false}return true}class a{constructor(){this.OnSendReply=undefined;this.cbRecvMethod={};this.cbRecvResult={};this.ProcRecvMethod={};this.ProcRecvMethod[this.JSONRecvMethod.AssignRole]=this.OnAssignRole.bind(this);this.ProcRecvMethod[this.JSONRecvMethod.GetDevDesc]=this.OnGetDevDesc.bind(this);this.ProcRecvMethod[this.JSONRecvMethod.Disconnect]=this.OnDisconnect.bind(this);this.ProcRecvMethod[this.JSONRecvMethod.AskStream]=this.OnAskStream.bind(this);this.ProcRecvMethod[this.JSONRecvMethod.AnswerRequest]=this.OnAnswerRequest.bind(this);this.ProcRecvMethod[this.JSONRecvMethod.CancelRequest]=this.OnCancelRequest.bind(this);this.ProcRecvResult={};this.ProcRecvResult[this.JSONSendMethod.GetService]=this.OnGetService.bind(this);this.ProcRecvResult[this.JSONSendMethod.RequestStream]=this.OnRequestStream.bind(this);chrome.storage.local.get("NoDisturb",(function(e){if(e.NoDisturb)s=e.NoDisturb;else{s=false;chrome.storage.local.set({NoDisturb:s})}}));chrome.storage.local.get("AutoAllow",(function(e){if(e.AutoAllow)r=e.AutoAllow;else{r=false;chrome.storage.local.set({AutoAllow:r})}}))}SetNoDisturb(e){s=e}SetAutoAllow(e){r=e}Role(){return c}Parse(e){if(d(e)){var t=JSON.parse(e);if(t.method!==undefined){if(this.ProcRecvMethod[t.method])this.ProcRecvMethod[t.method](t)}else if(t.result!==undefined){if(o[t.id]){if(this.ProcRecvResult[o[t.id]])this.ProcRecvResult[o[t.id]](t);delete o[t.id]}}else if(t.error){console.log(t.error)}}}setDevDesc(){var e=h();e.method=this.JSONSendMethod.SetDevDesc;e.params={capability:{host_control:{Version:2}},hostname:ESClientUserUniqueID};o[e.id]=e.method;return JSON.stringify(e)}requestStream(){var e=h();e.method=this.JSONSendMethod.RequestStream;o[e.id]=e.method;return JSON.stringify(e)}cancelRequest(){var e=h();e.method=this.JSONSendMethod.CancelRequest;o[e.id]=e.method;return JSON.stringify(e)}answerGuest(e,t){var s=h();s.method=this.JSONSendMethod.AnswerRequest;s.params={result:e?"allow":"deny",ip_address:t};o[s.id]=s.method;return JSON.stringify(s)}getService(){var e=h();e.method=this.JSONSendMethod.GetService;e.params={role:c,os:"chrome",country:ESClientCountryCode};o[e.id]=e.method;return JSON.stringify(e)}heartbeat(){var e={jsonrpc:"2.0",method:this.JSONSendMethod.Heartbeat};return JSON.stringify(e)}OnGetService(e){if(e.result&&this.cbRecvResult[o[e.id]])this.cbRecvResult[o[e.id]](e.result)}OnRequestStream(e){if(e.result.result&&this.cbRecvResult[o[e.id]])this.cbRecvResult[o[e.id]](e.result.result)}OnAssignRole(e){if(this.OnSendReply){var t={jsonrpc:"2.0",id:e.id,result:0};this.OnSendReply(JSON.stringify(t))}if(e.params&&e.params.role&&this.cbRecvMethod[e.method]){this.cbRecvMethod[e.method](e.params.role);c=e.params.role}}OnGetDevDesc(e){if(this.OnSendReply){var t={jsonrpc:"2.0",id:e.id};e.result={capability:{host_control:{Version:1}},hostname:"ESClientChromeApp"};this.OnSendReply(JSON.stringify(t))}}OnDisconnect(e){if(e.params&&this.cbRecvMethod[e.method]){this.cbRecvMethod[e.method](e.params.reason,e.params.message)}}OnAskStream(e){var t;var i;var o={jsonrpc:"2.0",result:{},id:e.id};var c=false;if(e.params&&e.params.hostname)t=e.params.hostname;if(e.params&&e.params.ip_address)i=e.params.ip_address;if(i){n[i]=t;o.result.ip_address=i}if(s)o.result.result="deny";else{if(r)o.result.result="allow";else{c=true;o.result.result="wait"}}if(this.OnSendReply)this.OnSendReply(JSON.stringify(o));if(c&&this.cbRecvMethod[e.method])this.cbRecvMethod[e.method](i)}OnAnswerRequest(e){if(this.OnSendReply){var t={jsonrpc:"2.0",id:e.id,result:0};this.OnSendReply(JSON.stringify(t))}if(e.params&&e.params.result&&this.cbRecvMethod[e.method])this.cbRecvMethod[e.method](e.params.result)}OnCancelRequest(e){if(this.OnSendReply){var t={jsonrpc:"2.0",id:e.id,result:0};this.OnSendReply(JSON.stringify(t))}if(e.params&&e.params.ip_address&&this.cbRecvMethod[e.method])this.cbRecvMethod[e.method](e.params.ip_address)}}a.prototype.JSONSendMethod={Heartbeat:"heartbeat",GetDevDesc:"common.get_device_description",SetDevDesc:"common.set_device_description",GetService:"common.get_service",RequestStream:"common.request_stream",AnswerRequest:"common.answer_request_stream",CancelRequest:"common.cancel_request_stream"};a.prototype.JSONRecvMethod={AssignRole:"common.assign_role",GetDevDesc:"common.get_device_description",Disconnect:"common.disconnect",AskStream:"common.ask_request_stream",AnswerRequest:"common.answer_request_stream",CancelRequest:"common.cancel_request_stream"};e["JSONHandler"]=a})(window["ESHARECMCLIENTBG"]["background"],window["ESHARECMCLIENTBG"]["Util"]);